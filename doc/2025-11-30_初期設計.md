# snaperro è©³ç´°è¨­è¨ˆæ›¸ v2

## æ¦‚è¦

**snaperro**ï¼ˆã‚¹ãƒŠãƒšãƒ¼ãƒ­ï¼‰ã¯ã€GUIä»˜ããƒ¢ãƒƒã‚¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã€‚
è¤‡æ•°ã®APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¨˜éŒ²ãƒ»å†ç”Ÿã—ã€é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆã‚’åŠ¹ç‡åŒ–ã™ã‚‹ã€‚

### åå‰ã®ç”±æ¥
- **snap**: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ç´ æ—©ãã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹
- **perro**: ã‚¹ãƒšã‚¤ãƒ³èªã§ã€ŒçŠ¬ã€ğŸ•
- ã€Œå¿ å®Ÿã«ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã‚‹çŠ¬ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| é …ç›® | é¸å®š |
|------|------|
| ã‚µãƒ¼ãƒãƒ¼ | Hono |
| GUI | React |
| GUIãƒ“ãƒ«ãƒ‰ | Vite |
| è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ | tsx |
| CLIãƒ©ã‚¤ãƒ–ãƒ©ãƒª | commander |
| ãƒ­ã‚° | consola |
| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹æˆ | å˜ä¸€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ |
| å…¬é–‹å…ˆ | npmï¼ˆå…¬é–‹äºˆå®šï¼‰ |

---

## Phase 1 (MVP) ã‚¹ã‚³ãƒ¼ãƒ—

### å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

1. **3ã¤ã®ãƒ¢ãƒ¼ãƒ‰**: Proxy / Record / Mock
2. **TypeScriptè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `snaperro.config.ts`
3. **é€£ç•ªå¯¾å¿œ**: åŒä¸€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€£ç•ªã§ç®¡ç†
4. **ãƒ¡ã‚½ãƒƒãƒ‰åˆ¥æŒ¯ã‚Šåˆ†ã‘**: GET/POSTç­‰ã§ç•°ãªã‚‹APIã«æŒ¯ã‚Šåˆ†ã‘å¯èƒ½
5. **Web GUI**: ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã€ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã€JSONé–²è¦§
6. **CLIã‚³ãƒãƒ³ãƒ‰**: `init`, `start`
7. **CORS**: å¸¸ã«è¨±å¯
8. **ãƒ­ã‚°å‡ºåŠ›**: consolaã€`--verbose` ã§è©³ç´°è¡¨ç¤º

### Phase 2 ã§å®Ÿè£…ï¼ˆä»Šå›ã¯å¯¾è±¡å¤–ï¼‰

- GUIä¸Šã§JSONç·¨é›†
- ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (`snaperro/client`)
- ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
- è¤‡è£½æ©Ÿèƒ½

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                snaperro server (Hono)                       â”‚
â”‚                     localhost:3333                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  React GUI  â”‚  â”‚   State     â”‚  â”‚    JSON Storage     â”‚ â”‚
â”‚  â”‚ (é™çš„é…ä¿¡)   â”‚â†â†’â”‚   Manager   â”‚â†â†’â”‚ .snaperro/          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:                                               â”‚
â”‚  /                    â†’ React SPA                          â”‚
â”‚  /__snaperro__/*      â†’ åˆ¶å¾¡API                            â”‚
â”‚  ãã®ä»–               â†’ ãƒ—ãƒ­ã‚­ã‚·/ãƒ¢ãƒƒã‚¯                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆï¼ˆsnaperroãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰

```
snaperro/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsup.config.ts
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆdefineConfigç­‰ï¼‰
â”‚   â”œâ”€â”€ cli/
â”‚   â”‚   â”œâ”€â”€ index.ts          # CLIã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼ˆcommanderï¼‰
â”‚   â”‚   â”œâ”€â”€ init.ts           # initã‚³ãƒãƒ³ãƒ‰
â”‚   â”‚   â””â”€â”€ start.ts          # startã‚³ãƒãƒ³ãƒ‰
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â”œâ”€â”€ index.ts          # Honoã‚µãƒ¼ãƒãƒ¼æœ¬ä½“
â”‚   â”‚   â”œâ”€â”€ proxy.ts          # Proxyãƒ¢ãƒ¼ãƒ‰å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ recorder.ts       # Recordãƒ¢ãƒ¼ãƒ‰å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ mocker.ts         # Mockãƒ¢ãƒ¼ãƒ‰å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ control-api.ts    # åˆ¶å¾¡API (/__snaperro__/*)
â”‚   â”‚   â””â”€â”€ cors.ts           # CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.ts         # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆtsxä½¿ç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ state.ts          # çŠ¶æ…‹ç®¡ç†ï¼ˆmode, pattern, counterï¼‰
â”‚   â”‚   â”œâ”€â”€ storage.ts        # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿æ›¸ã
â”‚   â”‚   â”œâ”€â”€ matcher.ts        # ãƒ‘ã‚¹ãƒãƒƒãƒãƒ³ã‚°ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰å¯¾å¿œï¼‰
â”‚   â”‚   â””â”€â”€ logger.ts         # ãƒ­ã‚°å‡ºåŠ›ï¼ˆconsolaï¼‰
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ config.ts         # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å‹å®šç¾©
â”‚       â””â”€â”€ recording.ts      # éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«å‹å®šç¾©
â”œâ”€â”€ gui/
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.tsx
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â”œâ”€â”€ App.css
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ client.ts     # åˆ¶å¾¡APIå‘¼ã³å‡ºã—
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Header.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ModeSelector.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PatternSelector.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FileTree.tsx
â”‚   â”‚   â”‚   â””â”€â”€ JsonViewer.tsx
â”‚   â”‚   â””â”€â”€ hooks/
â”‚   â”‚       â””â”€â”€ useSnaperro.ts
â”‚   â””â”€â”€ dist/                 # ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é…ä¿¡ï¼‰
â””â”€â”€ templates/
    â”œâ”€â”€ snaperro.config.ts    # initã§ç”Ÿæˆã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    â””â”€â”€ env.example           # .env.example ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
your-project/
â”œâ”€â”€ snaperro.config.ts     â† Gitç®¡ç†ã™ã‚‹
â”œâ”€â”€ .env                   â† Gitç®¡ç†ã—ãªã„
â”œâ”€â”€ .env.example           â† Gitç®¡ç†ã™ã‚‹
â”œâ”€â”€ .gitignore             â† ".snaperro" ã‚’è¿½åŠ 
â””â”€â”€ .snaperro/             â† Gitç®¡ç†ã—ãªã„ãƒ»è‡ªå‹•ç”Ÿæˆ
    â””â”€â”€ recordings/
        â”œâ”€â”€ æ­£å¸¸ç³»ãƒ•ãƒ«/
        â”‚   â””â”€â”€ api/
        â”‚       â””â”€â”€ users/
        â”‚           â”œâ”€â”€ GET_1.json
        â”‚           â”œâ”€â”€ GET_2.json
        â”‚           â””â”€â”€ POST_1.json
        â”œâ”€â”€ ç©ºãƒ‡ãƒ¼ã‚¿/
        â”‚   â””â”€â”€ api/
        â”‚       â””â”€â”€ users/
        â”‚           â””â”€â”€ GET_1.json
        â””â”€â”€ ã‚¨ãƒ©ãƒ¼ç³»/
            â””â”€â”€ ...
```

---

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

### snaperro.config.ts

```typescript
import { defineConfig } from 'snaperro'

export default defineConfig({
  port: 3333,

  apis: {
    // åŒã˜ãƒ‘ã‚¹ã§ã‚‚ãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ¯ã‚Šåˆ†ã‘å¯èƒ½
    userRead: {
      name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—",
      target: "https://user-api.example.com",
      headers: {
        "X-Api-Key": process.env.USER_API_KEY!,
      },
      match: ["GET /api/users/**"],
    },

    userWrite: {
      name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ»æ›´æ–°",
      target: "https://user-write-api.example.com",
      headers: {
        "X-Api-Key": process.env.USER_WRITE_API_KEY!,
      },
      match: ["POST /api/users/**", "PUT /api/users/**", "DELETE /api/users/**"],
    },

    orderService: {
      name: "æ³¨æ–‡ã‚µãƒ¼ãƒ“ã‚¹",
      target: "https://order-api.example.com",
      headers: {
        "Authorization": `Bearer ${process.env.ORDER_TOKEN}`,
      },
      // ãƒ¡ã‚½ãƒƒãƒ‰æŒ‡å®šãªã— = å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã«ãƒãƒƒãƒ
      match: ["/api/orders/**"],
    },

    authService: {
      name: "èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹",
      target: "https://auth.example.com",
      headers: {
        "X-Client-Secret": process.env.AUTH_SECRET!,
      },
      match: ["/auth/**"],
    },

    // ... ä»–ã®API
  },
})
```

### å‹å®šç¾©

```typescript
// src/types/config.ts

export interface ApiConfig {
  /** è¡¨ç¤ºåï¼ˆGUIãƒ»ãƒ­ã‚°ç”¨ï¼‰ */
  name: string
  /** ãƒ—ãƒ­ã‚­ã‚·å…ˆã®ãƒ™ãƒ¼ã‚¹URL */
  target: string
  /** ä»˜ä¸ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ©Ÿå¯†æƒ…å ±å«ã‚€ï¼‰ */
  headers?: Record<string, string>
  /**
   * ãƒãƒƒãƒã™ã‚‹ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆglobå½¢å¼ï¼‰
   * - "GET /api/users/**" â†’ GETãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ãƒãƒƒãƒ
   * - "/api/orders/**" â†’ å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã«ãƒãƒƒãƒ
   */
  match: string[]
}

export interface SnaperroConfig {
  /** ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3333ï¼‰ */
  port?: number
  /** APIè¨­å®š */
  apis: Record<string, ApiConfig>
}

export function defineConfig(config: SnaperroConfig): SnaperroConfig {
  return config
}
```

---

## éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

### ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹è¦å‰‡

```
.snaperro/recordings/{pattern}/{urlPath}/{METHOD}_{n}.json

ä¾‹:
.snaperro/recordings/æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_1.json
.snaperro/recordings/æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_2.json
.snaperro/recordings/æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/POST_1.json
.snaperro/recordings/æ­£å¸¸ç³»ãƒ•ãƒ«/api/orders/123/GET_1.json
```

### JSONã‚¹ã‚­ãƒ¼ãƒ

```typescript
// src/types/recording.ts

export interface RecordedData {
  request: {
    method: string
    url: string
    headers: Record<string, string>
    body?: unknown  // POST/PUT/PATCH ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
  }
  response: {
    status: number
    headers: Record<string, string>
    body: unknown
  }
  /** éŒ²ç”»æ—¥æ™‚ï¼ˆISO 8601ï¼‰ */
  recordedAt: string
}
```

### éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹

```json
{
  "request": {
    "method": "POST",
    "url": "/api/users",
    "headers": {
      "Content-Type": "application/json",
      "X-Request-Id": "abc-123"
    },
    "body": {
      "name": "ç”°ä¸­å¤ªéƒ",
      "email": "tanaka@example.com"
    }
  },
  "response": {
    "status": 201,
    "headers": {
      "Content-Type": "application/json",
      "X-Request-Id": "abc-123"
    },
    "body": {
      "id": 123,
      "name": "ç”°ä¸­å¤ªéƒ",
      "email": "tanaka@example.com",
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
  },
  "recordedAt": "2024-01-15T10:30:00.000Z"
}
```

---

## åˆ¶å¾¡API

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| Method | Path | èª¬æ˜ |
|--------|------|------|
| GET | `/__snaperro__/status` | ç¾åœ¨ã®çŠ¶æ…‹å–å¾— |
| POST | `/__snaperro__/mode` | ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ |
| POST | `/__snaperro__/pattern` | ãƒ‘ã‚¿ãƒ¼ãƒ³å¤‰æ›´ |
| GET | `/__snaperro__/patterns` | ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è¦§ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼å«ã‚€ï¼‰ |
| POST | `/__snaperro__/patterns` | æ–°è¦ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ |
| GET | `/__snaperro__/files/:pattern/**` | éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹å–å¾— |
| DELETE | `/__snaperro__/files/:pattern/**` | éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ |

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°

#### GET /__snaperro__/status

```typescript
// Response
{
  "mode": "mock",           // "proxy" | "record" | "mock"
  "pattern": "æ­£å¸¸ç³»ãƒ•ãƒ«",   // ç¾åœ¨é¸æŠä¸­ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
  "patterns": ["æ­£å¸¸ç³»ãƒ•ãƒ«", "ç©ºãƒ‡ãƒ¼ã‚¿", "ã‚¨ãƒ©ãƒ¼ç³»"]  // ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è¦§
}
```

#### POST /__snaperro__/mode

```typescript
// Request
{ "mode": "record" }

// Response (æˆåŠŸ)
{ "success": true, "mode": "record" }

// Response (ã‚¨ãƒ©ãƒ¼)
{ "success": false, "error": "Invalid mode: xxx" }
```

#### POST /__snaperro__/pattern

```typescript
// Request
{ "pattern": "ã‚¨ãƒ©ãƒ¼ç³»" }

// Response (æˆåŠŸ)
{ "success": true, "pattern": "ã‚¨ãƒ©ãƒ¼ç³»" }

// Response (ã‚¨ãƒ©ãƒ¼: ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå­˜åœ¨ã—ãªã„)
{ "success": false, "error": "Pattern not found: xxx" }
```

#### GET /__snaperro__/patterns

```typescript
// Response
{
  "patterns": [
    {
      "name": "æ­£å¸¸ç³»ãƒ•ãƒ«",
      "files": [
        {
          "path": "api/users/GET_1.json",
          "method": "GET",
          "status": 200,
          "size": 1234
        },
        {
          "path": "api/users/POST_1.json",
          "method": "POST",
          "status": 201,
          "size": 567
        }
      ]
    },
    {
      "name": "ç©ºãƒ‡ãƒ¼ã‚¿",
      "files": [...]
    }
  ]
}
```

#### POST /__snaperro__/patterns

```typescript
// Request
{ "name": "æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼" }

// Response (æˆåŠŸ)
{ "success": true, "name": "æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼" }

// Response (ã‚¨ãƒ©ãƒ¼: æ—¢ã«å­˜åœ¨)
{ "success": false, "error": "Pattern already exists: æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼" }
```

#### GET /__snaperro__/files/:pattern/**

```typescript
// GET /__snaperro__/files/æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_1.json

// Response: RecordedData ã®å†…å®¹ã‚’ãã®ã¾ã¾è¿”ã™
{
  "request": { ... },
  "response": { ... },
  "recordedAt": "..."
}
```

#### DELETE /__snaperro__/files/:pattern/**

```typescript
// DELETE /__snaperro__/files/æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_1.json

// Response (æˆåŠŸ)
{ "success": true }

// Response (ã‚¨ãƒ©ãƒ¼)
{ "success": false, "error": "File not found" }
```

---

## ãƒ‘ã‚¹ãƒãƒƒãƒãƒ³ã‚°ä»•æ§˜

### matchãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ›¸å¼

```
[METHOD ]<glob-pattern>

METHOD: GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONSï¼ˆçœç•¥æ™‚ã¯å…¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
glob-pattern: ãƒ‘ã‚¹ã®globãƒ‘ã‚¿ãƒ¼ãƒ³
```

### ãƒãƒƒãƒãƒ³ã‚°ä¾‹

| match | ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | ãƒãƒƒãƒ |
|-------|-----------|--------|
| `"/api/users/**"` | `GET /api/users` | âœ… |
| `"/api/users/**"` | `POST /api/users` | âœ… |
| `"/api/users/**"` | `GET /api/users/123` | âœ… |
| `"GET /api/users/**"` | `GET /api/users` | âœ… |
| `"GET /api/users/**"` | `POST /api/users` | âŒ |
| `"POST /api/users"` | `POST /api/users` | âœ… |
| `"POST /api/users"` | `POST /api/users/123` | âŒ |
| `"/api/*/items"` | `GET /api/orders/items` | âœ… |
| `"/api/*/items"` | `GET /api/orders/123/items` | âŒ |

### ãƒãƒƒãƒãƒ³ã‚°å„ªå…ˆé †ä½

1. **ãƒ¡ã‚½ãƒƒãƒ‰æŒ‡å®šã‚ã‚Š** > **ãƒ¡ã‚½ãƒƒãƒ‰æŒ‡å®šãªã—**
2. **å…ˆã«å®šç¾©ã•ã‚ŒãŸAPI** ãŒå„ªå…ˆ

```typescript
apis: {
  // 1. ã“ã‚ŒãŒå…ˆã«ãƒãƒƒãƒåˆ¤å®šã•ã‚Œã‚‹
  userWrite: {
    match: ["POST /api/users/**"],
  },
  // 2. POSTã¯ä¸Šã§ãƒãƒƒãƒã™ã‚‹ã®ã§ã€ã“ã‚Œã¯GETç­‰ã®ã¿ãƒãƒƒãƒ
  userRead: {
    match: ["/api/users/**"],
  },
}
```

### å®Ÿè£…

```typescript
// src/core/matcher.ts
import picomatch from 'picomatch'

interface MatchResult {
  apiKey: string
  apiConfig: ApiConfig
}

export function findMatchingApi(
  method: string,
  path: string,
  apis: Record<string, ApiConfig>
): MatchResult | null {
  for (const [apiKey, apiConfig] of Object.entries(apis)) {
    for (const pattern of apiConfig.match) {
      const { patternMethod, patternPath } = parsePattern(pattern)
      
      // ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆæŒ‡å®šãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      if (patternMethod && patternMethod !== method.toUpperCase()) {
        continue
      }
      
      // ãƒ‘ã‚¹ãƒã‚§ãƒƒã‚¯
      if (picomatch.isMatch(path, patternPath)) {
        return { apiKey, apiConfig }
      }
    }
  }
  return null
}

function parsePattern(pattern: string): { patternMethod: string | null, patternPath: string } {
  const methods = ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'HEAD', 'OPTIONS']
  const parts = pattern.split(' ')
  
  if (parts.length === 2 && methods.includes(parts[0].toUpperCase())) {
    return { patternMethod: parts[0].toUpperCase(), patternPath: parts[1] }
  }
  
  return { patternMethod: null, patternPath: pattern }
}
```

---

## çŠ¶æ…‹ç®¡ç†

### State Manager

```typescript
// src/core/state.ts

export type Mode = 'proxy' | 'record' | 'mock'

class StateManager {
  private mode: Mode = 'proxy'
  private pattern: string = ''
  private counter: Map<string, number> = new Map()

  getMode(): Mode {
    return this.mode
  }

  setMode(mode: Mode): void {
    this.mode = mode
    this.resetCounter()  // ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
  }

  getPattern(): string {
    return this.pattern
  }

  setPattern(pattern: string): void {
    this.pattern = pattern
    this.resetCounter()  // ãƒ‘ã‚¿ãƒ¼ãƒ³å¤‰æ›´æ™‚ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
  }

  /**
   * ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦ç¾åœ¨å€¤ã‚’è¿”ã™
   * @param method HTTPãƒ¡ã‚½ãƒƒãƒ‰
   * @param path ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹
   * @returns ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆå¾Œã®ã‚«ã‚¦ãƒ³ãƒˆå€¤
   */
  incrementCounter(method: string, path: string): number {
    const key = `${method.toUpperCase()}:${path}`
    const current = this.counter.get(key) ?? 0
    const next = current + 1
    this.counter.set(key, next)
    return next
  }

  resetCounter(): void {
    this.counter.clear()
  }

  getStatus() {
    return {
      mode: this.mode,
      pattern: this.pattern,
    }
  }
}

// ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³
export const state = new StateManager()
```

---

## ãƒ¢ãƒ¼ãƒ‰åˆ¥å‡¦ç†ãƒ•ãƒ­ãƒ¼

### Proxy ãƒ¢ãƒ¼ãƒ‰

```typescript
// src/server/proxy.ts

export async function handleProxy(
  c: Context,
  apiConfig: ApiConfig
): Promise<Response> {
  const { method, path, headers, body } = extractRequest(c)
  
  const targetUrl = `${apiConfig.target}${path}`
  
  logger.info(`${method} ${path} â†’ proxy â†’ ${targetUrl}`)
  
  const startTime = Date.now()
  
  try {
    const response = await fetch(targetUrl, {
      method,
      headers: {
        ...headers,
        ...apiConfig.headers,  // è¨­å®šã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸
      },
      body,
    })
    
    const elapsed = Date.now() - startTime
    logger.info(`  â†’ ${response.status} (${elapsed}ms)`)
    
    return response
  } catch (error) {
    logger.error(`Proxy failed: ${error.message}`)
    return c.json({ error: 'Bad Gateway' }, 502)
  }
}
```

### Record ãƒ¢ãƒ¼ãƒ‰

```typescript
// src/server/recorder.ts

export async function handleRecord(
  c: Context,
  apiConfig: ApiConfig
): Promise<Response> {
  const { method, path, headers, body } = extractRequest(c)
  const targetUrl = `${apiConfig.target}${path}`
  
  logger.info(`${method} ${path} â†’ record`)
  
  try {
    // 1. å®ŸAPIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const response = await fetch(targetUrl, {
      method,
      headers: {
        ...headers,
        ...apiConfig.headers,
      },
      body,
    })
    
    // 2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’å–å¾—
    const responseBody = await response.json()
    
    // 3. é€£ç•ªã‚’å–å¾—
    const count = state.incrementCounter(method, path)
    
    // 4. éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const recordedData: RecordedData = {
      request: {
        method,
        url: path,
        headers: Object.fromEntries(c.req.raw.headers),
        body: body ? JSON.parse(body) : undefined,
      },
      response: {
        status: response.status,
        headers: Object.fromEntries(response.headers),
        body: responseBody,
      },
      recordedAt: new Date().toISOString(),
    }
    
    // 5. ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    const filePath = buildFilePath(state.getPattern(), path, method, count)
    await storage.write(filePath, recordedData)
    
    const fileSize = JSON.stringify(recordedData).length
    logger.info(`  â†’ saved ${filePath} (${response.status}, ${formatSize(fileSize)})`)
    
    // 6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
    return c.json(responseBody, response.status, Object.fromEntries(response.headers))
  } catch (error) {
    logger.error(`Record failed: ${error.message}`)
    return c.json({ error: 'Bad Gateway' }, 502)
  }
}
```

### Mock ãƒ¢ãƒ¼ãƒ‰

```typescript
// src/server/mocker.ts

export async function handleMock(
  c: Context
): Promise<Response> {
  const { method, path } = extractRequest(c)
  
  // 1. é€£ç•ªã‚’å–å¾—
  const count = state.incrementCounter(method, path)
  
  // 2. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ§‹ç¯‰
  let filePath = buildFilePath(state.getPattern(), path, method, count)
  
  // 3. ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
  if (!await storage.exists(filePath)) {
    // é€£ç•ªãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ã€æœ€å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
    const lastFile = await storage.findLastFile(state.getPattern(), path, method)
    if (lastFile) {
      logger.warn(`${method} ${path} â†’ file not found: ${method}_${count}.json, using ${lastFile}`)
      filePath = lastFile
    } else {
      logger.warn(`${method} ${path} â†’ no mock file found`)
      return c.json({ error: 'Mock file not found' }, 404)
    }
  }
  
  // 4. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  const recordedData = await storage.read(filePath)
  
  logger.info(`${method} ${path} â†’ mock â†’ ${filePath} (${recordedData.response.status})`)
  
  // 5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
  return c.json(
    recordedData.response.body,
    recordedData.response.status,
    recordedData.response.headers
  )
}
```

---

## ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œ

```typescript
// src/core/storage.ts
import fs from 'fs/promises'
import path from 'path'

const BASE_DIR = '.snaperro/recordings'

export const storage = {
  async write(filePath: string, data: RecordedData): Promise<void> {
    const fullPath = path.join(BASE_DIR, filePath)
    await fs.mkdir(path.dirname(fullPath), { recursive: true })
    await fs.writeFile(fullPath, JSON.stringify(data, null, 2), 'utf-8')
  },

  async read(filePath: string): Promise<RecordedData> {
    const fullPath = path.join(BASE_DIR, filePath)
    const content = await fs.readFile(fullPath, 'utf-8')
    return JSON.parse(content)
  },

  async exists(filePath: string): Promise<boolean> {
    const fullPath = path.join(BASE_DIR, filePath)
    try {
      await fs.access(fullPath)
      return true
    } catch {
      return false
    }
  },

  async findLastFile(pattern: string, urlPath: string, method: string): Promise<string | null> {
    const dir = path.join(BASE_DIR, pattern, urlPath)
    try {
      const files = await fs.readdir(dir)
      const methodFiles = files
        .filter(f => f.startsWith(`${method}_`) && f.endsWith('.json'))
        .sort((a, b) => {
          const numA = parseInt(a.match(/_(\d+)\.json$/)?.[1] ?? '0')
          const numB = parseInt(b.match(/_(\d+)\.json$/)?.[1] ?? '0')
          return numB - numA  // é™é †
        })
      
      if (methodFiles.length > 0) {
        return path.join(pattern, urlPath, methodFiles[0])
      }
    } catch {
      // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„
    }
    return null
  },

  async listPatterns(): Promise<string[]> {
    try {
      const entries = await fs.readdir(BASE_DIR, { withFileTypes: true })
      return entries.filter(e => e.isDirectory()).map(e => e.name)
    } catch {
      return []
    }
  },

  async createPattern(name: string): Promise<void> {
    const dir = path.join(BASE_DIR, name)
    await fs.mkdir(dir, { recursive: true })
  },

  async getPatternFiles(pattern: string): Promise<FileInfo[]> {
    // å†å¸°çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
    // ...å®Ÿè£…çœç•¥
  },
}

function buildFilePath(pattern: string, urlPath: string, method: string, count: number): string {
  // /api/users â†’ api/users
  const normalizedPath = urlPath.startsWith('/') ? urlPath.slice(1) : urlPath
  return path.join(pattern, normalizedPath, `${method.toUpperCase()}_${count}.json`)
}
```

---

## ãƒ­ã‚°å‡ºåŠ›

### Loggerå®Ÿè£…

```typescript
// src/core/logger.ts
import { consola, createConsola } from 'consola'

let isVerbose = false

export const logger = {
  setVerbose(verbose: boolean) {
    isVerbose = verbose
    if (verbose) {
      consola.level = 4  // debug
    }
  },

  info(message: string) {
    const time = new Date().toLocaleTimeString('ja-JP')
    consola.info(`[${time}] ${message}`)
  },

  debug(message: string) {
    if (isVerbose) {
      const time = new Date().toLocaleTimeString('ja-JP')
      consola.debug(`[${time}] ${message}`)
    }
  },

  warn(message: string) {
    const time = new Date().toLocaleTimeString('ja-JP')
    consola.warn(`[${time}] âš ï¸  ${message}`)
  },

  error(message: string, error?: Error) {
    const time = new Date().toLocaleTimeString('ja-JP')
    consola.error(`[${time}] âŒ ${message}`)
    if (error && isVerbose) {
      consola.error(error.stack)
    }
  },

  /**
   * æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚¹ã‚¯ã—ã¦ãƒ­ã‚°å‡ºåŠ›ï¼ˆ--verboseæ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤ºç”¨ï¼‰
   */
  debugHeaders(headers: Record<string, string>) {
    if (!isVerbose) return
    
    const masked = Object.entries(headers).map(([key, value]) => {
      const lowerKey = key.toLowerCase()
      if (
        lowerKey.includes('key') ||
        lowerKey.includes('secret') ||
        lowerKey.includes('token') ||
        lowerKey.includes('authorization')
      ) {
        // æœ€åˆã®4æ–‡å­—ã ã‘è¡¨ç¤º
        const visible = value.slice(0, 4)
        return `  ${key}: ${visible}${'*'.repeat(Math.min(value.length - 4, 10))}`
      }
      return `  ${key}: ${value}`
    })
    
    consola.debug('Headers:')
    masked.forEach(line => consola.debug(line))
  },

  startup(port: number, mode: string, pattern: string) {
    consola.box({
      title: 'ğŸ• snaperro',
      message: [
        `Server running at http://localhost:${port}`,
        `Mode: ${mode} | Pattern: ${pattern || '(none)'}`,
      ].join('\n'),
    })
  },
}
```

### ãƒ­ã‚°å‡ºåŠ›ä¾‹

#### é€šå¸¸ãƒ¢ãƒ¼ãƒ‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚  ğŸ• snaperro                            â”‚
â”‚  Server running at http://localhost:3333â”‚
â”‚  Mode: mock | Pattern: æ­£å¸¸ç³»ãƒ•ãƒ«        â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[10:30:15] â„¹ GET /api/users â†’ mock â†’ æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_1.json (200)
[10:30:16] â„¹ POST /api/users â†’ mock â†’ æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/POST_1.json (201)
[10:30:17] âš ï¸  GET /api/users/999 â†’ file not found: GET_5.json, using GET_3.json
[10:31:00] â„¹ Mode changed: mock â†’ record
[10:31:05] â„¹ GET /api/users â†’ record â†’ saved api/users/GET_1.json (200, 1.2KB)
```

#### è©³ç´°ãƒ¢ãƒ¼ãƒ‰ï¼ˆ--verboseï¼‰

```
[10:30:15] ğŸ” GET /api/users
[10:30:15]   Matched: userRead (GET /api/users/**)
[10:30:15]   Mode: mock
[10:30:15]   Counter: GET:/api/users â†’ 1
[10:30:15]   File: .snaperro/recordings/æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_1.json
[10:30:15] â„¹ GET /api/users â†’ mock â†’ æ­£å¸¸ç³»ãƒ•ãƒ«/api/users/GET_1.json (200)

[10:31:05] ğŸ” GET /api/users
[10:31:05]   Matched: userRead (GET /api/users/**)
[10:31:05]   Mode: record
[10:31:05]   Proxy to: https://user-api.example.com/api/users
[10:31:05]   Headers:
[10:31:05]     X-Api-Key: usr_**********
[10:31:05]     Content-Type: application/json
[10:31:05]   Upstream: 200 OK (234ms)
[10:31:05] â„¹ GET /api/users â†’ record â†’ saved api/users/GET_1.json (200, 1.2KB)
```

---

## CLIã‚³ãƒãƒ³ãƒ‰

### ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

```typescript
// src/cli/index.ts
import { program } from 'commander'
import { init } from './init'
import { start } from './start'

program
  .name('snaperro')
  .description('ğŸ• GUIä»˜ããƒ¢ãƒƒã‚¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼')
  .version('1.0.0')

program
  .command('init')
  .description('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–')
  .action(init)

program
  .command('start')
  .description('ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•')
  .option('-p, --port <port>', 'ãƒãƒ¼ãƒˆç•ªå·', '3333')
  .option('-v, --verbose', 'è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›')
  .action(start)

program.parse()
```

### initã‚³ãƒãƒ³ãƒ‰

```typescript
// src/cli/init.ts
import fs from 'fs/promises'
import path from 'path'
import { consola } from 'consola'

export async function init() {
  consola.start('snaperro ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...')

  // 1. .snaperro/recordings/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
  await fs.mkdir('.snaperro/recordings', { recursive: true })
  consola.success('.snaperro/recordings/ ã‚’ä½œæˆã—ã¾ã—ãŸ')

  // 2. .gitignore ã«è¿½åŠ 
  await appendToGitignore()
  
  // 3. snaperro.config.ts ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
  if (!await fileExists('snaperro.config.ts')) {
    const template = await fs.readFile(
      path.join(__dirname, '../templates/snaperro.config.ts'),
      'utf-8'
    )
    await fs.writeFile('snaperro.config.ts', template)
    consola.success('snaperro.config.ts ã‚’ä½œæˆã—ã¾ã—ãŸ')
  } else {
    consola.info('snaperro.config.ts ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™')
  }

  // 4. .env.example ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
  if (!await fileExists('.env.example')) {
    const template = await fs.readFile(
      path.join(__dirname, '../templates/env.example'),
      'utf-8'
    )
    await fs.writeFile('.env.example', template)
    consola.success('.env.example ã‚’ä½œæˆã—ã¾ã—ãŸ')
  } else {
    consola.info('.env.example ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™')
  }

  consola.box('ğŸ• åˆæœŸåŒ–å®Œäº†ï¼\n\n1. snaperro.config.ts ã‚’ç·¨é›†\n2. .env ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š\n3. npx snaperro start ã§èµ·å‹•')
}

async function appendToGitignore() {
  const gitignorePath = '.gitignore'
  const entry = '.snaperro'
  
  try {
    const content = await fs.readFile(gitignorePath, 'utf-8')
    if (content.includes(entry)) {
      consola.info('.gitignore ã«ã¯æ—¢ã« .snaperro ãŒå«ã¾ã‚Œã¦ã„ã¾ã™')
      return
    }
    await fs.appendFile(gitignorePath, `\n# snaperro\n${entry}\n`)
    consola.success('.gitignore ã« .snaperro ã‚’è¿½åŠ ã—ã¾ã—ãŸ')
  } catch {
    await fs.writeFile(gitignorePath, `# snaperro\n${entry}\n`)
    consola.success('.gitignore ã‚’ä½œæˆã—ã¾ã—ãŸ')
  }
}

async function fileExists(filePath: string): Promise<boolean> {
  try {
    await fs.access(filePath)
    return true
  } catch {
    return false
  }
}
```

### startã‚³ãƒãƒ³ãƒ‰

```typescript
// src/cli/start.ts
import { consola } from 'consola'
import { loadConfig } from '../core/config'
import { createServer } from '../server'
import { logger } from '../core/logger'
import { state } from '../core/state'
import { storage } from '../core/storage'

interface StartOptions {
  port?: string
  verbose?: boolean
}

export async function start(options: StartOptions) {
  // è©³ç´°ãƒ­ã‚°è¨­å®š
  logger.setVerbose(options.verbose ?? false)

  // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  let config
  try {
    config = await loadConfig()
  } catch (error) {
    consola.error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
    consola.error(error.message)
    consola.info('npx snaperro init ã‚’å®Ÿè¡Œã—ã¦åˆæœŸåŒ–ã—ã¦ãã ã•ã„')
    process.exit(1)
  }

  // ãƒãƒ¼ãƒˆæ±ºå®šï¼ˆCLIå¼•æ•° > è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  const port = parseInt(options.port ?? String(config.port ?? 3333))

  // åˆæœŸãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®šï¼ˆæœ€åˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠï¼‰
  const patterns = await storage.listPatterns()
  if (patterns.length > 0) {
    state.setPattern(patterns[0])
  }

  // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
  const server = createServer(config)
  
  logger.startup(port, state.getMode(), state.getPattern())
  
  server.listen(port)
}
```

---

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿

```typescript
// src/core/config.ts
import path from 'path'
import { pathToFileURL } from 'url'
import type { SnaperroConfig } from '../types/config'

export async function loadConfig(): Promise<SnaperroConfig> {
  const configPath = path.resolve(process.cwd(), 'snaperro.config.ts')
  
  // tsx ã‚’ä½¿ã£ã¦ TypeScript ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
  // æ³¨: tsx ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã¾ãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹
  try {
    // å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    const configModule = await import(pathToFileURL(configPath).href)
    const config = configModule.default as SnaperroConfig
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    validateConfig(config)
    
    return config
  } catch (error) {
    if (error.code === 'ERR_MODULE_NOT_FOUND') {
      throw new Error(`è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${configPath}`)
    }
    throw error
  }
}

function validateConfig(config: SnaperroConfig): void {
  if (!config.apis || Object.keys(config.apis).length === 0) {
    console.warn('è­¦å‘Š: apis ãŒç©ºã§ã™ã€‚ãƒ—ãƒ­ã‚­ã‚·å…ˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')
  }

  for (const [key, api] of Object.entries(config.apis ?? {})) {
    if (!api.name) {
      throw new Error(`apis.${key}.name ã¯å¿…é ˆã§ã™`)
    }
    if (!api.target) {
      throw new Error(`apis.${key}.target ã¯å¿…é ˆã§ã™`)
    }
    if (!api.match || api.match.length === 0) {
      throw new Error(`apis.${key}.match ã¯å¿…é ˆã§ã™`)
    }
  }
}
```

---

## ã‚µãƒ¼ãƒãƒ¼æœ¬ä½“

```typescript
// src/server/index.ts
import { Hono } from 'hono'
import { serveStatic } from 'hono/serve-static'
import { cors } from './cors'
import { controlApi } from './control-api'
import { handleRequest } from './handler'
import type { SnaperroConfig } from '../types/config'

export function createServer(config: SnaperroConfig) {
  const app = new Hono()

  // CORSï¼ˆå¸¸ã«è¨±å¯ï¼‰
  app.use('*', cors())

  // åˆ¶å¾¡API
  app.route('/__snaperro__', controlApi)

  // GUIï¼ˆé™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ï¼‰
  app.use('/*', serveStatic({ root: './gui/dist' }))
  app.get('/', serveStatic({ path: './gui/dist/index.html' }))

  // ãƒ—ãƒ­ã‚­ã‚·/ãƒ¢ãƒƒã‚¯ï¼ˆå…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒƒãƒï¼‰
  app.all('*', (c) => handleRequest(c, config))

  return app
}
```

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```typescript
// src/server/handler.ts
import type { Context } from 'hono'
import { findMatchingApi } from '../core/matcher'
import { state } from '../core/state'
import { logger } from '../core/logger'
import { handleProxy } from './proxy'
import { handleRecord } from './recorder'
import { handleMock } from './mocker'
import type { SnaperroConfig } from '../types/config'

export async function handleRequest(c: Context, config: SnaperroConfig) {
  const method = c.req.method
  const path = new URL(c.req.url).pathname

  // ãƒãƒƒãƒã™ã‚‹APIè¨­å®šã‚’æ¤œç´¢
  const match = findMatchingApi(method, path, config.apis)
  
  if (!match) {
    logger.warn(`${method} ${path} â†’ No matching API`)
    return c.json({ error: 'No matching API found' }, 404)
  }

  logger.debug(`${method} ${path} â†’ Matched: ${match.apiKey}`)

  // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
  const mode = state.getMode()
  
  switch (mode) {
    case 'proxy':
      return handleProxy(c, match.apiConfig)
    case 'record':
      return handleRecord(c, match.apiConfig)
    case 'mock':
      return handleMock(c)
  }
}
```

### CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```typescript
// src/server/cors.ts
import type { MiddlewareHandler } from 'hono'

export function cors(): MiddlewareHandler {
  return async (c, next) => {
    // ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    if (c.req.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': '*',
          'Access-Control-Allow-Headers': '*',
        },
      })
    }

    await next()

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 
    c.res.headers.set('Access-Control-Allow-Origin', '*')
  }
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |
|--------|---------------|-----------|
| è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãªã— | - | CLIçµ‚äº† + ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| ãƒãƒƒãƒã™ã‚‹APIãªã— | 404 | `{ "error": "No matching API found" }` |
| Mockãƒ•ã‚¡ã‚¤ãƒ«ãªã— | 404 | `{ "error": "Mock file not found" }` |
| Proxyå…ˆãŒå¿œç­”ã—ãªã„ | 502 | `{ "error": "Bad Gateway" }` |
| JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ | 500 | `{ "error": "Failed to parse mock file" }` |
| ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿å¤±æ•— | 500 | `{ "error": "Failed to save recording" }` |

---

## GUIè¨­è¨ˆ

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
App
â”œâ”€â”€ Headerï¼ˆãƒ­ã‚´ã€URLè¡¨ç¤ºï¼‰
â”œâ”€â”€ ModeSelectorï¼ˆProxy / Record / Mock åˆ‡ã‚Šæ›¿ãˆï¼‰
â”œâ”€â”€ PatternSelectorï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ + æ–°è¦ä½œæˆï¼‰
â””â”€â”€ MainContent
    â”œâ”€â”€ FileTreeï¼ˆå·¦: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ï¼‰
    â””â”€â”€ JsonViewerï¼ˆå³: JSONè¡¨ç¤ºï¼‰
```

### useSnaperro ãƒ•ãƒƒã‚¯

```typescript
// gui/src/hooks/useSnaperro.ts
import { useState, useEffect, useCallback } from 'react'

interface SnaperroState {
  mode: 'proxy' | 'record' | 'mock'
  pattern: string
  patterns: PatternInfo[]
  selectedFile: string | null
  fileContent: RecordedData | null
  loading: boolean
}

interface PatternInfo {
  name: string
  files: FileInfo[]
}

interface FileInfo {
  path: string
  method: string
  status: number
  size: number
}

export function useSnaperro() {
  const [state, setState] = useState<SnaperroState>({
    mode: 'proxy',
    pattern: '',
    patterns: [],
    selectedFile: null,
    fileContent: null,
    loading: true,
  })

  // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
  useEffect(() => {
    fetchStatus()
    fetchPatterns()
  }, [])

  const fetchStatus = async () => {
    const res = await fetch('/__snaperro__/status')
    const data = await res.json()
    setState(s => ({ ...s, mode: data.mode, pattern: data.pattern, loading: false }))
  }

  const fetchPatterns = async () => {
    const res = await fetch('/__snaperro__/patterns')
    const data = await res.json()
    setState(s => ({ ...s, patterns: data.patterns }))
  }

  const setMode = useCallback(async (mode: string) => {
    await fetch('/__snaperro__/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode }),
    })
    setState(s => ({ ...s, mode: mode as SnaperroState['mode'] }))
  }, [])

  const setPattern = useCallback(async (pattern: string) => {
    await fetch('/__snaperro__/pattern', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pattern }),
    })
    setState(s => ({ ...s, pattern }))
  }, [])

  const createPattern = useCallback(async (name: string) => {
    await fetch('/__snaperro__/patterns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name }),
    })
    await fetchPatterns()
    await setPattern(name)
  }, [setPattern])

  const selectFile = useCallback(async (filePath: string) => {
    setState(s => ({ ...s, selectedFile: filePath, fileContent: null }))
    const res = await fetch(`/__snaperro__/files/${state.pattern}/${filePath}`)
    const data = await res.json()
    setState(s => ({ ...s, fileContent: data }))
  }, [state.pattern])

  const deleteFile = useCallback(async (filePath: string) => {
    await fetch(`/__snaperro__/files/${state.pattern}/${filePath}`, {
      method: 'DELETE',
    })
    await fetchPatterns()
    if (state.selectedFile === filePath) {
      setState(s => ({ ...s, selectedFile: null, fileContent: null }))
    }
  }, [state.pattern, state.selectedFile])

  return {
    ...state,
    setMode,
    setPattern,
    createPattern,
    selectFile,
    deleteFile,
    refresh: fetchPatterns,
  }
}
```

### GUIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ• snaperro                                 localhost:3333    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  ãƒ¢ãƒ¼ãƒ‰: â—‹ Proxy  â—‹ Record  â— Mock                            â”‚
â”‚                                                                â”‚
â”‚  ãƒ‘ã‚¿ãƒ¼ãƒ³: [æ­£å¸¸ç³»ãƒ•ãƒ« â–¼]  [+ æ–°è¦ä½œæˆ]                         â”‚
â”‚                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ æ­£å¸¸ç³»ãƒ•ãƒ«        â”‚  api/users/GET_1.json                   â”‚
â”‚  â”œâ”€ ğŸ“ api           â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚  â”œâ”€ ğŸ“ users      â”‚  {                                      â”‚
â”‚  â”‚  â”‚  â”œâ”€ GET_1.json â”‚    "request": {                         â”‚
â”‚  â”‚  â”‚  â”œâ”€ GET_2.json â”‚      "method": "GET",                   â”‚
â”‚  â”‚  â”‚  â””â”€ POST_1.jsonâ”‚      "url": "/api/users"                â”‚
â”‚  â”‚  â””â”€ ğŸ“ orders     â”‚    },                                   â”‚
â”‚  â”‚     â””â”€ GET_1.json â”‚    "response": {                        â”‚
â”‚  â”‚                   â”‚      "status": 200,                     â”‚
â”‚  â”‚                   â”‚      "body": { ... }                    â”‚
â”‚  â”‚                   â”‚    }                                    â”‚
â”‚  â”‚                   â”‚  }                                      â”‚
â”‚  â”‚                   â”‚                                         â”‚
â”‚  â”‚                   â”‚  [å‰Šé™¤]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

### package.json

```json
{
  "name": "snaperro",
  "version": "1.0.0",
  "description": "ğŸ• GUIä»˜ããƒ¢ãƒƒã‚¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "bin": {
    "snaperro": "./dist/cli/index.js"
  },
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": [
    "dist",
    "gui/dist",
    "templates"
  ],
  "scripts": {
    "dev": "tsup --watch",
    "build": "tsup && npm run build:gui",
    "build:gui": "cd gui && npm run build",
    "test": "vitest"
  },
  "dependencies": {
    "hono": "^4.0.0",
    "commander": "^12.0.0",
    "consola": "^3.0.0",
    "picomatch": "^3.0.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "tsup": "^8.0.0",
    "tsx": "^4.0.0",
    "vitest": "^1.0.0",
    "@types/node": "^20.0.0",
    "@types/picomatch": "^2.0.0"
  },
  "peerDependencies": {
    "tsx": "^4.0.0"
  },
  "engines": {
    "node": ">=18"
  }
}
```

### gui/package.json

```json
{
  "name": "snaperro-gui",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0"
  }
}
```

---

## å®Ÿè£…é †åº

### Step 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºç›¤ï¼ˆ1-2æ™‚é–“ï¼‰

1. `package.json` ä½œæˆ
2. `tsconfig.json` ä½œæˆ
3. `tsup.config.ts` ä½œæˆ
4. `src/types/config.ts` - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å‹å®šç¾©
5. `src/types/recording.ts` - éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«å‹å®šç¾©
6. `src/index.ts` - defineConfig ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

### Step 2: ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ2-3æ™‚é–“ï¼‰

1. `src/core/logger.ts` - ãƒ­ã‚°å‡ºåŠ›
2. `src/core/config.ts` - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
3. `src/core/matcher.ts` - ãƒ‘ã‚¹ãƒãƒƒãƒãƒ³ã‚°
4. `src/core/state.ts` - çŠ¶æ…‹ç®¡ç†
5. `src/core/storage.ts` - ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ

### Step 3: ã‚µãƒ¼ãƒãƒ¼ï¼ˆ2-3æ™‚é–“ï¼‰

1. `src/server/cors.ts` - CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
2. `src/server/proxy.ts` - Proxyãƒ¢ãƒ¼ãƒ‰
3. `src/server/recorder.ts` - Recordãƒ¢ãƒ¼ãƒ‰
4. `src/server/mocker.ts` - Mockãƒ¢ãƒ¼ãƒ‰
5. `src/server/control-api.ts` - åˆ¶å¾¡API
6. `src/server/handler.ts` - ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
7. `src/server/index.ts` - ã‚µãƒ¼ãƒãƒ¼æœ¬ä½“

### Step 4: CLIï¼ˆ1æ™‚é–“ï¼‰

1. `src/cli/init.ts` - initã‚³ãƒãƒ³ãƒ‰
2. `src/cli/start.ts` - startã‚³ãƒãƒ³ãƒ‰
3. `src/cli/index.ts` - CLIã‚¨ãƒ³ãƒˆãƒªãƒ¼
4. `templates/snaperro.config.ts` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
5. `templates/env.example` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### Step 5: GUIï¼ˆ3-4æ™‚é–“ï¼‰

1. Vite + React ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
2. `gui/src/hooks/useSnaperro.ts` - APIé€šä¿¡
3. `gui/src/components/Header.tsx`
4. `gui/src/components/ModeSelector.tsx`
5. `gui/src/components/PatternSelector.tsx`
6. `gui/src/components/FileTree.tsx`
7. `gui/src/components/JsonViewer.tsx`
8. `gui/src/App.tsx` - ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
9. ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°

### Step 6: çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆï¼ˆ1-2æ™‚é–“ï¼‰

1. ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
2. å‹•ä½œç¢ºèª
3. READMEä½œæˆ

---

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

### templates/snaperro.config.ts

```typescript
import { defineConfig } from 'snaperro'

export default defineConfig({
  port: 3333,

  apis: {
    // ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼API
    // userService: {
    //   name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹",
    //   target: "https://api.example.com",
    //   headers: {
    //     "X-Api-Key": process.env.API_KEY!,
    //   },
    //   match: ["/api/users/**"],
    // },
  },
})
```

### templates/env.example

```
# snaperro ç’°å¢ƒå¤‰æ•°

# API_KEY=your-api-key-here
# AUTH_TOKEN=your-auth-token-here
```

---

## æ³¨æ„äº‹é …

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- `.snaperro/` ã«ã¯æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ãŒå«ã¾ã‚Œã‚‹
- `init` ã§ `.gitignore` ã«è‡ªå‹•è¿½åŠ 
- æ©Ÿå¯†æƒ…å ±ã¯ãƒ­ã‚°å‡ºåŠ›æ™‚ã«ãƒã‚¹ã‚¯ï¼ˆ`--verbose` æ™‚ã‚‚ï¼‰

### åˆ¶é™äº‹é …

- ãƒã‚¤ãƒŠãƒªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯éå¯¾å¿œ
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯éå¯¾å¿œï¼ˆå…¨ã¦ãƒ¡ãƒ¢ãƒªã«å±•é–‹ï¼‰
- WebSocket ã¯éå¯¾å¿œ

### å‹•ä½œè¦ä»¶

- Node.js 18ä»¥ä¸Š
- tsx ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆpeerDependenciesï¼‰