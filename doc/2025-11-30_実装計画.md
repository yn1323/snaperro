# snaperro 実装計画

## 概要
設計ドキュメント（doc/2025-11-30_初期設計.md）に基づき、Phase 1 (MVP) を実装する。

## 品質担保方針
各Stepの完了条件：
1. `pnpm type-check` が通る
2. `pnpm format` が通る
3. 単体テスト（Vitest）が通る
4. 手動確認観点をリストアップし、確認済み

## 既存パッケージの活用
- `@biomejs/biome` - Linter/Formatter（継続）
- `dayjs` - 録画日時のフォーマット等に活用
- `zod` - 設定ファイル・リクエスト/レスポンスのバリデーションに活用

## 追加パッケージ
- `hono` - サーバー
- `commander` - CLI
- `consola` - ログ
- `picomatch` - パスマッチング
- `tsup` - ビルド
- `tsx` - TypeScript実行
- `vitest` - テスト
- `react`, `react-dom` - GUI
- `vite`, `@vitejs/plugin-react` - GUIビルド

---

## Step 1: プロジェクト基盤

### 実装内容
1. package.json 更新（依存関係追加、scripts追加）
2. tsconfig.json 作成
3. tsup.config.ts 作成
4. vitest.config.ts 作成
5. src/types/config.ts - 設定ファイル型定義（Zodスキーマ）
6. src/types/recording.ts - 録画ファイル型定義（Zodスキーマ）
7. src/index.ts - defineConfig エクスポート

### テスト
- src/types/config.test.ts - Zodスキーマのバリデーションテスト
- src/types/recording.test.ts - Zodスキーマのバリデーションテスト

### 手動確認観点
- [ ] `pnpm install` が成功する
- [ ] `pnpm type-check` が通る
- [ ] `pnpm test` が通る
- [ ] `pnpm build` が成功する（空でもエラーなし）

---

## Step 2: コアロジック

### 実装内容
1. src/core/logger.ts - ログ出力（consola）
2. src/core/config.ts - 設定ファイル読み込み
3. src/core/matcher.ts - パスマッチング（picomatch）
4. src/core/state.ts - 状態管理
5. src/core/storage.ts - ファイル操作

### テスト
- src/core/matcher.test.ts - パスマッチングのテスト（設計書のマッチング例を網羅）
- src/core/state.test.ts - 状態管理のテスト（カウンター、モード切替）
- src/core/storage.test.ts - ファイル読み書きのテスト

### 手動確認観点
- [ ] matcherが設計書の全マッチング例で正しく動作する
- [ ] storageがファイルを正しく読み書きできる
- [ ] stateのカウンターがモード/パターン変更時にリセットされる

---

## Step 3: サーバー

### 実装内容
1. src/server/cors.ts - CORSミドルウェア
2. src/server/proxy.ts - Proxyモード
3. src/server/recorder.ts - Recordモード（dayjs使用）
4. src/server/mocker.ts - Mockモード
5. src/server/control-api.ts - 制御API（Zod使用）
6. src/server/handler.ts - リクエストハンドラー
7. src/server/index.ts - サーバー本体

### テスト
- src/server/control-api.test.ts - 制御APIのテスト（各エンドポイント）
- src/server/proxy.test.ts - Proxyモードのテスト
- src/server/recorder.test.ts - Recordモードのテスト（ファイル保存確認）
- src/server/mocker.test.ts - Mockモードのテスト（連番、最後のファイル fallback）

### 手動確認観点
- [ ] CORSヘッダーが正しく付与される
- [ ] Proxyモードで実際のAPIにリクエストが転送される
- [ ] Recordモードでファイルが正しい形式で保存される
- [ ] Mockモードで保存済みファイルが返却される
- [ ] 連番が正しくインクリメントされる
- [ ] 制御APIでモード/パターン切替ができる

---

## Step 4: CLI

### 実装内容
1. src/cli/init.ts - initコマンド
2. src/cli/start.ts - startコマンド
3. src/cli/index.ts - CLIエントリー
4. templates/snaperro.config.ts - テンプレート
5. templates/env.example - テンプレート

### テスト
- src/cli/init.test.ts - initコマンドのテスト（ファイル生成、.gitignore更新）

### 手動確認観点
- [ ] `npx snaperro init` で .snaperro/, snaperro.config.ts, .env.example が生成される
- [ ] .gitignore に .snaperro が追加される（既存の場合はスキップ）
- [ ] `npx snaperro start` でサーバーが起動する
- [ ] `npx snaperro start --verbose` で詳細ログが出る
- [ ] `npx snaperro start -p 4000` でポート指定が効く

---

## Step 5: GUI

### 実装内容
1. gui/package.json
2. gui/tsconfig.json
3. gui/vite.config.ts
4. gui/index.html
5. gui/src/main.tsx
6. gui/src/App.tsx
7. gui/src/App.css
8. gui/src/api/client.ts - 制御API呼び出し
9. gui/src/hooks/useSnaperro.ts
10. gui/src/components/Header.tsx
11. gui/src/components/ModeSelector.tsx
12. gui/src/components/PatternSelector.tsx
13. gui/src/components/FileTree.tsx
14. gui/src/components/JsonViewer.tsx

### テスト
- gui/src/hooks/useSnaperro.test.ts - フックのテスト（モック使用）

### 手動確認観点
- [ ] `http://localhost:3333` でGUIが表示される
- [ ] モード切替（Proxy/Record/Mock）が動作する
- [ ] パターン選択が動作する
- [ ] 新規パターン作成が動作する
- [ ] ファイルツリーが表示される
- [ ] ファイル選択でJSONが表示される
- [ ] ファイル削除が動作する

---

## Step 6: 統合・テスト

### 実装内容
1. ビルドスクリプト確認・修正
2. README.md 作成（使い方）

### テスト
- 全テストが通ることを確認

### 手動確認観点（E2Eシナリオ）
- [ ] `npx snaperro init` → `npx snaperro start` の一連の流れ
- [ ] Recordモードで録画 → Mockモードで再生
- [ ] 連番リクエストが正しく動作する
- [ ] GUIからモード/パターン切替 → 即座に反映される
- [ ] 設定ファイルのAPI定義が正しくマッチする
