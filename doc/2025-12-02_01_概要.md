# snaperro 概要

## プロジェクト概要

**snaperro**（スナペーロ）は、GUI付きモックプロキシサーバーです。
複数のAPIからのレスポンスを記録・再生し、開発・テストを効率化します。

---

## 背景・ペイン

### 現状の課題

案件で**複数API（20種類）**をつないで1つのリストを作るシステムを開発中。

#### 環境の問題

| 環境 | 状態 | 問題 |
|-----|------|------|
| **本番環境** | 20種のAPI間で整合性が取れている | 開発用途での接続は避けたい |
| **テスト環境** | 誰かが勝手に本番データをコピー | API間の整合性が取れていない |

#### 組織の制約

- 下請けの立場で環境をコントロールできない
- 組織が大規模すぎる（このAPIを使うチームが無数にある）
- テスト環境のデータ整合性改善は調整不可能

### 現状の対策（MSW改造）

現在はMSWを改造して以下を実現：

1. 本番APIへのリクエスト + レスポンスのJSON保存機能
2. JSONパターンにグループ名を付ける機能
3. 画面右下にFloating UIを配置
4. Webページのリロードなしでパターン切り替え
5. Storybook対応

#### 現状の問題点

- **プロダクトにべったり紐づいている** — 再利用できない
- **新メンバーへの説明コストが高い** — 動きを理解させるのが大変
- **メンテナンスが分散** — ページごとにmocks/ディレクトリを切っている
- **フロント専用** — バックエンドでも同じ仕組みが必要になった

### 新たな要件

フロント＋バックエンドで作り直すことになり、**フロント・バック双方**で同じようなモック機能が必要に。

---

## 名前の由来

### snaperro（スナペーロ）

- **snap** — スナップショット、素早くキャプチャする
- **perro** — スペイン語で「犬」

「忠実にデータを取ってくる犬」というイメージ。

---

## 設計方針

### 基本コンセプト

- 独立したプロキシサーバーとして動作
- フロントエンド・バックエンド両方から同じように使える
- Web GUIでモード切替・パターン管理
- 設定はTypeScriptで型安全に

### フロント・バックの使い分け

フロントとバックで**同期は不要**。それぞれ独立してモックする。

```
フロント開発時:
  Frontend → [snaperro] → モック返却
  (Backendからのレスポンスをモック)

バックエンド開発時:
  Backend → [snaperro] → モック返却
  (外部APIをモック)
```

---

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| サーバーフレームワーク | Hono |
| CLI | Commander.js |
| バリデーション | Zod |
| パターンマッチング | Picomatch |
| ロギング | Consola |
| テスト | Vitest |
| ビルド | tsup |
| Linter/Formatter | Biome |
| パッケージマネージャー | pnpm |
| 日付 | dayjs |

---

## ファイル構成

```
your-project/
├── snaperro.config.ts     ← 設定ファイル（Git管理する）
├── .env                   ← secret類（Git管理しない）
├── .env.example           ← 環境変数テンプレ（Git管理する）
├── .gitignore             ← ".snaperro" を追加
└── .snaperro/             ← 録画データ（Git管理しない・自動生成）
    ├── state.json         ← サーバー状態（モード、パターン）
    └── recordings/
        ├── 正常系フル/
        │   ├── api_users_001.json
        │   ├── api_users_002.json
        │   └── api_orders_001.json
        ├── 空データ/
        │   └── api_users_001.json
        └── エラー系/
            └── api_users_001.json
```

### Git管理方針

| ファイル | Git管理 | 理由 |
|---------|--------|------|
| `snaperro.config.ts` | する | API定義、チームで共有すべき |
| `.env.example` | する | 環境変数のテンプレート |
| `.env` | しない | 実際のsecret |
| `.snaperro/` | しない | 機密データを含むJSON |

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                snaperro server (独立プロセス)                 │
│                     localhost:3333                          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Web GUI   │  │   Pattern   │  │    JSON Storage     │ │
│  │ パターン選択 │←→│   Manager   │←→│ .snaperro/          │ │
│  │ キャプチャ   │  │  (状態管理) │  │  └─ recordings/     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│         ↑              ↑                                    │
│         │              │                                    │
│  ┌──────┴──────────────┴────────┐                          │
│  │        REST API              │                          │
│  │ GET  /api/* → モック返却      │                          │
│  │ POST /__snaperro__/pattern   │                          │
│  │ POST /__snaperro__/mode      │                          │
│  └──────────────────────────────┘                          │
└─────────────────────────────────────────────────────────────┘
        ↑                              ↑
        │                              │
┌───────┴───────┐              ┌───────┴───────┐
│    Frontend   │              │    Backend    │
│  Next.js等    │              │  Express等    │
│ localhost:3000│              │ localhost:4000│
└───────────────┘              └───────────────┘
```

---

## チーム情報

- チーム規模: 5人程度
- バックエンド: Node.js (TypeScript)
- API: 全てREST（20種類）
- パターン数: 開発時3パターン、テストフェーズ時10パターン程度（+ エラーパターン）

---

## 関連ドキュメント

- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [内部API仕様](./2025-12-02_03_内部API仕様.md)
- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
- [JSONスキーマ仕様](./2025-12-02_06_JSONスキーマ仕様.md)
