# snaperro サーバー仕様

## 概要

snaperroはProxyつきモックサーバーです。
3つのモードを切り替えて、APIレスポンスの記録・再生を行います。

---

## 3つのモード

| モード | 本物のAPI | JSON保存 | 返すもの | ユースケース |
|-------|----------|---------|---------|-------------|
| **Proxy** | アクセスする | しない | 本物のレスポンス | 普通に開発、設定統一したい |
| **Record** | アクセスする | する | 本物のレスポンス | 今の状態を保存したい |
| **Mock** | アクセスしない | しない | 保存済みJSON | 保存データで開発・テスト |

### Proxyモード

モックを返さずに、従来のエンドポイントにそのまま接続します。

```
リクエスト → snaperro → 実際のAPI → レスポンス
```

- 設定ファイルで定義されたヘッダー（API Key等）を付与
- レスポンスはそのままクライアントに返却
- ファイル保存は行わない

### Recordモード

従来のエンドポイントに接続しつつ、レスポンスをJSONファイルに記録します。

```
リクエスト → snaperro → 実際のAPI → レスポンス
                ↓
           JSONファイルに保存
```

- オンにすると、選択中のパターンディレクトリに記録
- リクエスト情報（パラメータ、ヘッダー、ボディ）とレスポンスを保存
- **同じエンドポイント、同じリクエストパラメータ**の場合：後勝ち（上書き）
- **同じエンドポイント、異なるリクエストパラメータ**の場合：別ファイルを生成

### Mockモード

保存済みのJSONファイルからモックレスポンスを返却します。

```
リクエスト → snaperro → JSONファイルを検索 → レスポンス
             （実際のAPIにはアクセスしない）
```

- HTTPメソッド + リクエストパラメータでマッチング
- マッチするファイルがない場合は404エラーを返却

---

## ファイル命名規則

### 基本ルール

エンドポイントのパスをファイル名に変換します。

| エンドポイント | ファイル名 |
|--------------|-----------|
| `/user` | `user_001.json` |
| `/user/post` | `user_post_001.json` |
| `/api/users` | `api_users_001.json` |
| `/api/users/:id/orders` | `api_users_{id}_orders_001.json` |

### 変換ルール

1. パスの先頭 `/` を削除
2. `/` を `_` に変換
3. パスパラメータ（`:id` 等）は `{id}` 形式に変換
4. 連番 `_001` を付与（3桁0埋め）

### 連番について

**重要**: 連番は「N回目のリクエスト」という意味ではありません。

連番は**リクエストパラメータの違いを区別するため**に使用します。

```
api_users_001.json  → GET /api/users?status=active
api_users_002.json  → GET /api/users?status=inactive
api_users_003.json  → POST /api/users (body: {"name": "田中"})
```

同じエンドポイントでも、リクエストパラメータが異なれば別ファイルになります。

### HTTPメソッドの扱い

HTTPメソッドはファイル名に含めません。JSON内部で保持します。

```
❌ api_users_get_001.json
✅ api_users_001.json （JSON内に "method": "GET" を記録）
```

---

## パターン管理

### 概要

パターンはフォルダ単位で管理します。
用途別に複数のモックデータセットを切り替えられます。

```
.snaperro/
└── recordings/
    ├── 正常系フル/          ← パターン1
    │   ├── api_users_001.json
    │   └── api_orders_001.json
    ├── 空データ/            ← パターン2
    │   └── api_users_001.json
    └── エラー系/            ← パターン3
        └── api_users_001.json
```

### パターンの用途例

| パターン名 | 用途 |
|-----------|------|
| 正常系フル | 全データが揃った状態 |
| 空データ | データが0件の状態 |
| エラー系 | APIエラーを返す状態 |
| 決済エラー | 決済APIのみエラーを返す |
| 大量データ | ページネーションテスト用 |

### Recordモードでのパターン

Record開始前にパターン（保存先フォルダ）を選択します。
記録されたデータは選択中のパターンフォルダに保存されます。

### Mockモードでのパターン

Mock開始前にパターン（使用フォルダ）を選択します。
リクエストに対して、選択中のパターンフォルダ内のJSONを検索します。

---

## マッチングロジック

### Mockモードでのファイル選択

リクエストが来た際、以下の条件でJSONファイルを検索します：

1. **エンドポイント**が一致
2. **HTTPメソッド**が一致
3. **リクエストパラメータ**が一致

### リクエストパラメータの種類

マッチングに使用するリクエストパラメータは以下の4種類です：

| 種類 | 例 |
|-----|-----|
| クエリパラメータ | `?id=1&name=tanaka` |
| リクエストボディ | `{ "name": "田中" }` |
| パスパラメータ | `/user/123` の `123` |
| リクエストヘッダー | `Authorization: Bearer xxx` |

### マッチング例

```
記録済みファイル:
├── api_users_{id}_001.json  (GET, pathParams: {id: "1"})
├── api_users_{id}_002.json  (GET, pathParams: {id: "2"})
└── api_users_{id}_003.json  (POST, pathParams: {id: "1"}, body: {...})

リクエスト: GET /api/users/1
→ api_users_{id}_001.json を返却（id=1、GETでマッチ）

リクエスト: GET /api/users/2
→ api_users_{id}_002.json を返却（id=2、GETでマッチ）

リクエスト: POST /api/users/1
→ api_users_{id}_003.json を返却（id=1、POSTでマッチ）

リクエスト: GET /api/users/999
→ 404エラー（マッチするファイルなし）
```

### マッチしない場合の挙動

マッチするファイルがない場合は、**404エラー**を返却します。

```json
{
  "error": "No matching mock found",
  "endpoint": "/api/users/999",
  "method": "GET"
}
```

---

## 状態の永続化

### state.json

サーバーの状態は `.snaperro/state.json` に保存されます。

```json
{
  "mode": "mock",
  "currentPattern": "正常系フル"
}
```

### 動作

- サーバー起動時: `state.json` を読み込み、前回の状態を復元
- 状態変更時: `state.json` を更新
- ファイルがない場合: デフォルト値（mode: "proxy", currentPattern: null）

---

## エラーハンドリング

### Proxyモード

| 状況 | 挙動 |
|-----|------|
| 実APIが応答しない | タイムアウトエラーを返却 |
| 実APIが5xxエラー | エラーレスポンスをそのまま返却 |

### Recordモード

| 状況 | 挙動 |
|-----|------|
| 実APIが応答しない | タイムアウトエラーを返却（記録しない） |
| 実APIが5xxエラー | エラーレスポンスを記録して返却 |
| ファイル書き込み失敗 | エラーログを出力、レスポンスは返却 |

### Mockモード

| 状況 | 挙動 |
|-----|------|
| マッチするファイルなし | 404エラーを返却 |
| JSONパース失敗 | 500エラーを返却 |

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [内部API仕様](./2025-12-02_03_内部API仕様.md)
- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
- [JSONスキーマ仕様](./2025-12-02_06_JSONスキーマ仕様.md)
