# snaperro 内部API仕様

## 概要

snaperroサーバーは、GUIや外部からサーバーを制御するための内部APIを提供します。
全てのエンドポイントは `/__snaperro__/` プレフィックスを使用します。

---

## エンドポイント一覧

### サーバー状態

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/status` | サーバー状態の一括取得 |

### SSE イベントストリーム

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/events` | リアルタイムイベント受信（Server-Sent Events） |

### モード操作

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/mode` | 現在のモード取得 |
| PUT | `/__snaperro__/mode` | モード変更 |

### パターン操作

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/patterns` | パターン一覧取得 |
| GET | `/__snaperro__/patterns/current` | 現在選択中のパターン取得 |
| PUT | `/__snaperro__/patterns/current` | パターン切替 |
| POST | `/__snaperro__/patterns` | 新規パターン作成 |
| POST | `/__snaperro__/patterns/:name/duplicate` | パターン複製 |
| PUT | `/__snaperro__/patterns/:name/rename` | パターン名変更 |
| DELETE | `/__snaperro__/patterns/:name` | パターン削除 |
| GET | `/__snaperro__/patterns/:name/download` | パターンzipダウンロード |
| POST | `/__snaperro__/patterns/upload` | パターンzipアップロード |

### 記録データ操作

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/recordings` | 記録ファイル一覧取得 |
| GET | `/__snaperro__/recordings/:filename` | 記録ファイル内容取得 |
| GET | `/__snaperro__/recordings/:filename/download` | 記録ファイル個別ダウンロード |
| POST | `/__snaperro__/recordings/upload` | 記録ファイルアップロード |
| PUT | `/__snaperro__/recordings/:filename` | 記録ファイル編集 |
| DELETE | `/__snaperro__/recordings/:filename` | 記録ファイル削除 |

---

## エンドポイント詳細

### GET /__snaperro__/status

サーバーの現在の状態を一括で取得します。

**レスポンス**

```json
{
  "mode": "mock",
  "currentPattern": "正常系フル",
  "patterns": ["正常系フル", "空データ", "エラー系"],
  "recordingsCount": 15
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| mode | string | 現在のモード（proxy/record/mock） |
| currentPattern | string \| null | 選択中のパターン名 |
| patterns | string[] | パターン一覧 |
| recordingsCount | number | 現在のパターン内の記録ファイル数 |

---

### GET /__snaperro__/events

GUIがサーバーの変更をリアルタイムで受信するためのSSE（Server-Sent Events）エンドポイントです。

**接続方法（クライアント側）**

```typescript
const eventSource = new EventSource('http://localhost:3333/__snaperro__/events');

// 接続確認
eventSource.addEventListener('connected', (e) => {
  console.log('Connected:', JSON.parse(e.data));
});

// モード変更イベント
eventSource.addEventListener('mode:changed', (e) => {
  const { mode } = JSON.parse(e.data);
  console.log('Mode changed to:', mode);
});

// パターン作成イベント
eventSource.addEventListener('pattern:created', (e) => {
  const { name } = JSON.parse(e.data);
  console.log('Pattern created:', name);
});

// 記録ファイル作成イベント（Recordモード時含む）
eventSource.addEventListener('recordings:created', (e) => {
  const { pattern, filename, endpoint, method, isNew } = JSON.parse(e.data);
  console.log('Recording created:', filename);
});

// 接続を閉じる
eventSource.close();
```

**イベント種別**

| イベント | payload | 発火タイミング |
|---------|---------|---------------|
| `connected` | `{ timestamp }` | 接続確立時 |
| `ping` | `{ timestamp }` | 30秒ごとのkeep-alive |
| `mode:changed` | `{ mode }` | モード変更時 |
| `pattern:changed` | `{ pattern }` | パターン切替時 |
| `pattern:created` | `{ name }` | パターン作成時 |
| `pattern:deleted` | `{ name }` | パターン削除時 |
| `pattern:renamed` | `{ oldName, newName }` | パターン名変更時 |
| `pattern:duplicated` | `{ source, destination }` | パターン複製時 |
| `pattern:uploaded` | `{ name, recordingsCount }` | パターンアップロード時 |
| `recordings:changed` | `{ pattern, filename }` | 記録ファイル編集時 |
| `recordings:created` | `{ pattern, filename, endpoint, method, isNew }` | 記録ファイル作成時（Recordモード含む） |
| `recordings:deleted` | `{ pattern, filename }` | 記録ファイル削除時 |
| `recordings:uploaded` | `{ pattern, filename }` | 記録ファイルアップロード時 |

**特徴**

- 接続時に `connected` イベントが送信される
- 30秒ごとに `ping` イベントを送信して接続を維持
- クライアント切断時は自動的にリスナーが解除される
- 複数クライアントの同時接続に対応

---

### GET /__snaperro__/mode

現在のモードを取得します。

**レスポンス**

```json
{
  "mode": "mock"
}
```

---

### PUT /__snaperro__/mode

モードを変更します。

**リクエスト**

```json
{
  "mode": "record"
}
```

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| mode | string | Yes | 変更先のモード（proxy/record/mock） |

**レスポンス**

```json
{
  "mode": "record",
  "message": "Mode changed to record"
}
```

**エラーレスポンス**

```json
{
  "error": "Invalid mode",
  "validModes": ["proxy", "record", "mock"]
}
```

---

### GET /__snaperro__/patterns

パターン一覧を取得します。

**レスポンス**

```json
{
  "patterns": [
    {
      "name": "正常系フル",
      "recordingsCount": 10,
      "createdAt": "2025-12-02T10:00:00.000Z",
      "updatedAt": "2025-12-02T12:00:00.000Z"
    },
    {
      "name": "空データ",
      "recordingsCount": 3,
      "createdAt": "2025-12-02T10:30:00.000Z",
      "updatedAt": "2025-12-02T10:30:00.000Z"
    }
  ]
}
```

---

### GET /__snaperro__/patterns/current

現在選択中のパターンを取得します。

**レスポンス**

```json
{
  "currentPattern": "正常系フル"
}
```

パターンが選択されていない場合：

```json
{
  "currentPattern": null
}
```

---

### PUT /__snaperro__/patterns/current

パターンを切り替えます。

**リクエスト**

```json
{
  "pattern": "エラー系"
}
```

**レスポンス**

```json
{
  "currentPattern": "エラー系",
  "message": "Pattern changed to エラー系"
}
```

**エラーレスポンス**

```json
{
  "error": "Pattern not found",
  "pattern": "存在しないパターン"
}
```

---

### POST /__snaperro__/patterns

新規パターンを作成します。

**リクエスト**

```json
{
  "name": "決済エラー"
}
```

**レスポンス**

```json
{
  "name": "決済エラー",
  "message": "Pattern created"
}
```

**エラーレスポンス**

```json
{
  "error": "Pattern already exists",
  "name": "決済エラー"
}
```

---

### POST /__snaperro__/patterns/:name/duplicate

既存パターンを複製します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | 複製元のパターン名 |

**リクエスト**

```json
{
  "newName": "正常系フル_コピー"
}
```

**レスポンス**

```json
{
  "source": "正常系フル",
  "destination": "正常系フル_コピー",
  "message": "Pattern duplicated"
}
```

---

### PUT /__snaperro__/patterns/:name/rename

パターン名を変更します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | 現在のパターン名 |

**リクエスト**

```json
{
  "newName": "正常系_完全版"
}
```

**レスポンス**

```json
{
  "oldName": "正常系フル",
  "newName": "正常系_完全版",
  "message": "Pattern renamed"
}
```

---

### DELETE /__snaperro__/patterns/:name

パターンを削除します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | 削除するパターン名 |

**レスポンス**

```json
{
  "name": "エラー系",
  "message": "Pattern deleted"
}
```

**エラーレスポンス（選択中のパターンを削除しようとした場合）**

```json
{
  "error": "Cannot delete current pattern",
  "name": "正常系フル"
}
```

---

### GET /__snaperro__/patterns/:name/download

パターンをzipファイルとしてダウンロードします。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | ダウンロードするパターン名 |

**レスポンス**

- Content-Type: `application/zip`
- Content-Disposition: `attachment; filename="正常系フル.zip"`
- Body: zipファイルのバイナリデータ

---

### POST /__snaperro__/patterns/upload

zipファイルからパターンをアップロードします。

**リクエスト**

- Content-Type: `multipart/form-data`
- Body:
  - `file`: zipファイル
  - `name`: パターン名（省略時はzipファイル名を使用）

**レスポンス**

```json
{
  "name": "アップロードパターン",
  "recordingsCount": 5,
  "message": "Pattern uploaded"
}
```

---

### GET /__snaperro__/recordings

現在のパターン内の記録ファイル一覧を取得します。

**レスポンス**

```json
{
  "pattern": "正常系フル",
  "recordings": [
    {
      "filename": "api_users_001.json",
      "endpoint": "/api/users",
      "method": "GET",
      "size": 1024,
      "updatedAt": "2025-12-02T12:00:00.000Z"
    },
    {
      "filename": "api_users_002.json",
      "endpoint": "/api/users",
      "method": "POST",
      "size": 2048,
      "updatedAt": "2025-12-02T12:30:00.000Z"
    }
  ]
}
```

---

### GET /__snaperro__/recordings/:filename

記録ファイルの内容を取得します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| filename | ファイル名（例: `api_users_001.json`） |

**レスポンス**

```json
{
  "endpoint": "/api/users",
  "method": "GET",
  "request": {
    "pathParams": {},
    "queryParams": { "status": "active" },
    "headers": { "Authorization": "Bearer xxx" },
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": {
      "users": [
        { "id": 1, "name": "田中" }
      ]
    }
  }
}
```

---

### GET /__snaperro__/recordings/:filename/download

記録ファイルを個別にダウンロードします。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| filename | ファイル名 |

**レスポンス**

- Content-Type: `application/json`
- Content-Disposition: `attachment; filename="api_users_001.json"`
- Body: JSONファイルの内容

---

### POST /__snaperro__/recordings/upload

記録ファイルをアップロードします。

**リクエスト**

- Content-Type: `multipart/form-data`
- Body:
  - `file`: JSONファイル

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "Recording uploaded"
}
```

---

### PUT /__snaperro__/recordings/:filename

記録ファイルの内容を編集します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| filename | ファイル名 |

**リクエスト**

```json
{
  "endpoint": "/api/users",
  "method": "GET",
  "request": {
    "pathParams": {},
    "queryParams": { "status": "active" },
    "headers": {},
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": {
      "users": []
    }
  }
}
```

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "Recording updated"
}
```

---

### DELETE /__snaperro__/recordings/:filename

記録ファイルを削除します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| filename | ファイル名 |

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "Recording deleted"
}
```

---

## 共通エラーレスポンス

### 400 Bad Request

リクエストが不正な場合

```json
{
  "error": "Invalid request",
  "details": "Missing required field: name"
}
```

### 404 Not Found

リソースが見つからない場合

```json
{
  "error": "Not found",
  "resource": "pattern",
  "name": "存在しないパターン"
}
```

### 500 Internal Server Error

サーバー内部エラー

```json
{
  "error": "Internal server error",
  "message": "Failed to write file"
}
```

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
- [JSONスキーマ仕様](./2025-12-02_06_JSONスキーマ仕様.md)
