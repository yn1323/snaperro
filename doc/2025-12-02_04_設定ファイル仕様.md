# snaperro 設定ファイル仕様

## 概要

snaperroの設定は `snaperro.config.ts` ファイルで管理します。
TypeScriptで記述するため、型安全に設定できます。

---

## 設定ファイルの場所

```
your-project/
├── snaperro.config.ts   ← プロジェクトルートに配置
├── .env                 ← 環境変数（secret類）
└── ...
```

---

## 基本構造

```typescript
// snaperro.config.ts
import { defineConfig } from 'snaperro'

export default defineConfig({
  port: 3333,
  filesDir: '.snaperro/files',
  apis: {
    // API定義
  },
})
```

---

## 設定オプション

### port

サーバーのポート番号を指定します。

| 項目 | 値 |
|-----|-----|
| 型 | `number` |
| 必須 | No |
| デフォルト | `3333` |

```typescript
defineConfig({
  port: 4000,
})
```

### filesDir

記録データの保存先ディレクトリを指定します。

| 項目 | 値 |
|-----|-----|
| 型 | `string` |
| 必須 | No |
| デフォルト | `'.snaperro/files'` |

```typescript
defineConfig({
  filesDir: '.snaperro/files',
})
```

### apis

API定義のオブジェクトです。キーはAPI識別子、値はAPI設定です。

| 項目 | 値 |
|-----|-----|
| 型 | `Record<string, ApiConfig>` |
| 必須 | Yes |

---

## API定義

### 構造

```typescript
apis: {
  userService: {
    name: "ユーザーサービス",
    target: "https://user-api.example.com",
    headers: {
      "X-Api-Key": process.env.USER_API_KEY!,
    },
    routes: [
      "/api/users",
      "/api/users/:id",
      "/api/users/:id/orders",
      "/api/users/:id/orders/:orderId",
    ],
  },
}
```

### ApiConfig

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | `string` | Yes | API表示名（GUI表示用） |
| target | `string` | Yes | プロキシ先のベースURL |
| headers | `Record<string, string>` | No | リクエストに付与するヘッダー |
| routes | `string[]` | Yes | ルートパターンの配列 |

---

## ルート定義

### 基本

リクエストパスとマッチするパターンを定義します。

```typescript
routes: [
  "/api/users",           // 完全一致
  "/api/users/:id",       // パスパラメータ付き
]
```

### パスパラメータ

`:param` 形式でパスパラメータを定義します。

```typescript
routes: [
  "/api/users/:id",                    // :id がパラメータ
  "/api/users/:id/orders/:orderId",    // 複数パラメータ
]
```

パスパラメータは以下の用途で使用されます：

1. **ファイル名変換**: `/api/users/:id` → `api_users_{id}_001.json`
2. **マッチング**: リクエスト `/api/users/123` がパターンにマッチ
3. **JSON内記録**: `pathParams: { "id": "123" }` として保存

### マッチング例

```typescript
routes: ["/api/users/:id/orders/:orderId"]
```

| リクエスト | マッチ | pathParams |
|-----------|--------|------------|
| `/api/users/1/orders/100` | Yes | `{ id: "1", orderId: "100" }` |
| `/api/users/abc/orders/xyz` | Yes | `{ id: "abc", orderId: "xyz" }` |
| `/api/users/1` | No | - |
| `/api/users/1/orders` | No | - |

---

## ヘッダー設定

### 静的ヘッダー

```typescript
headers: {
  "X-Api-Key": "your-api-key",
  "Content-Type": "application/json",
}
```

### 環境変数を使用

```typescript
headers: {
  "X-Api-Key": process.env.USER_API_KEY!,
  "Authorization": `Bearer ${process.env.AUTH_TOKEN}`,
}
```

### .env ファイル

```env
# .env
USER_API_KEY=your-secret-api-key
AUTH_TOKEN=your-secret-token
```

```env
# .env.example（Git管理用テンプレート）
USER_API_KEY=
AUTH_TOKEN=
```

---

## 完全な設定例

```typescript
// snaperro.config.ts
import { defineConfig } from 'snaperro'

export default defineConfig({
  port: 3333,
  filesDir: '.snaperro/files',

  apis: {
    // ユーザーサービス
    userService: {
      name: "ユーザーサービス",
      target: "https://user-api.example.com",
      headers: {
        "X-Api-Key": process.env.USER_API_KEY!,
      },
      routes: [
        "/api/users",
        "/api/users/:id",
        "/api/users/:id/profile",
        "/api/users/:id/settings",
      ],
    },

    // 注文サービス
    orderService: {
      name: "注文サービス",
      target: "https://order-api.example.com",
      headers: {
        "Authorization": `Bearer ${process.env.ORDER_TOKEN}`,
      },
      routes: [
        "/api/orders",
        "/api/orders/:id",
        "/api/users/:userId/orders",
        "/api/users/:userId/orders/:orderId",
      ],
    },

    // 認証サービス
    authService: {
      name: "認証サービス",
      target: "https://auth.example.com",
      headers: {
        "X-Client-Secret": process.env.AUTH_SECRET!,
      },
      routes: [
        "/auth/login",
        "/auth/logout",
        "/auth/refresh",
        "/auth/verify",
      ],
    },

    // 決済サービス
    paymentService: {
      name: "決済サービス",
      target: "https://payment-api.example.com",
      headers: {
        "X-Payment-Key": process.env.PAYMENT_API_KEY!,
      },
      routes: [
        "/payment/checkout",
        "/payment/confirm",
        "/payment/refund/:transactionId",
        "/payment/history/:userId",
      ],
    },
  },
})
```

---

## 型定義

```typescript
interface SnaperroConfig {
  /**
   * サーバーポート番号
   * @default 3333
   */
  port?: number

  /**
   * 記録データの保存先ディレクトリ
   * @default '.snaperro/files'
   */
  filesDir?: string

  /**
   * API定義
   */
  apis: Record<string, ApiConfig>
}

interface ApiConfig {
  /**
   * API表示名（GUI表示用）
   */
  name: string

  /**
   * プロキシ先のベースURL
   */
  target: string

  /**
   * リクエストに付与するヘッダー
   */
  headers?: Record<string, string>

  /**
   * ルートパターンの配列
   * パスパラメータは :param 形式で定義
   */
  routes: string[]
}

/**
 * 設定を定義するヘルパー関数
 */
export function defineConfig(config: SnaperroConfig): SnaperroConfig {
  return config
}
```

---

## 設定の検証

snaperroは起動時に設定ファイルを検証します。

### 検証項目

- `apis` が空でないこと
- 各APIの `name`, `target`, `routes` が定義されていること
- `routes` が空でないこと
- `target` が有効なURLであること

### エラー例

```
Error: Invalid configuration
- apis.userService.target: Invalid URL
- apis.orderService.routes: Cannot be empty
```

---

## ベストプラクティス

### 1. 環境変数は .env で管理

```typescript
// Good
headers: {
  "X-Api-Key": process.env.API_KEY!,
}

// Bad（セキュリティリスク）
headers: {
  "X-Api-Key": "hardcoded-secret-key",
}
```

### 2. API識別子は一貫した命名規則

```typescript
// Good
apis: {
  userService: { ... },
  orderService: { ... },
  authService: { ... },
}

// Bad（不統一）
apis: {
  users: { ... },
  OrderAPI: { ... },
  auth_service: { ... },
}
```

### 3. ルートは具体的に定義

```typescript
// Good
routes: [
  "/api/users",
  "/api/users/:id",
  "/api/users/:id/orders",
]

// 避けるべき（曖昧）
routes: [
  "/api/**",
]
```

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [内部API仕様](./2025-12-02_03_内部API仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
- [JSONスキーマ仕様](./2025-12-02_06_JSONスキーマ仕様.md)
