# snaperro JSONスキーマ仕様

## 概要

snaperroで使用するJSONファイルのスキーマを定義します。

---

## ファイル一覧

| ファイル | 場所 | 用途 |
|---------|------|------|
| 記録ファイル | `.snaperro/recordings/{pattern}/*.json` | リクエスト・レスポンスの記録 |
| state.json | `.snaperro/state.json` | サーバー状態の永続化 |

---

## 記録ファイル (Recording)

### ファイル配置

```
.snaperro/
└── recordings/
    └── {パターン名}/
        ├── api_users_001.json
        ├── api_users_002.json
        └── api_orders_{id}_001.json
```

### スキーマ

```json
{
  "endpoint": "/api/users/:id",
  "method": "GET",
  "request": {
    "pathParams": { "id": "123" },
    "queryParams": { "include": "profile" },
    "headers": { "Authorization": "Bearer xxx" },
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": {
      "id": 123,
      "name": "田中太郎"
    }
  }
}
```

### フィールド詳細

#### endpoint

| 項目 | 値 |
|-----|-----|
| 型 | `string` |
| 必須 | Yes |
| 説明 | エンドポイントのパスパターン（パスパラメータ含む） |

```json
"endpoint": "/api/users/:id/orders/:orderId"
```

#### method

| 項目 | 値 |
|-----|-----|
| 型 | `string` |
| 必須 | Yes |
| 値 | `"GET"` \| `"POST"` \| `"PUT"` \| `"PATCH"` \| `"DELETE"` \| `"OPTIONS"` \| `"HEAD"` |
| 説明 | HTTPメソッド |

```json
"method": "POST"
```

#### request

リクエスト情報を格納するオブジェクト。

| 項目 | 値 |
|-----|-----|
| 型 | `RequestData` |
| 必須 | Yes |

##### request.pathParams

| 項目 | 値 |
|-----|-----|
| 型 | `Record<string, string>` |
| 必須 | Yes |
| 説明 | パスパラメータのキー・値 |

```json
"pathParams": {
  "id": "123",
  "orderId": "456"
}
```

##### request.queryParams

| 項目 | 値 |
|-----|-----|
| 型 | `Record<string, string \| string[]>` |
| 必須 | Yes |
| 説明 | クエリパラメータのキー・値 |

```json
"queryParams": {
  "status": "active",
  "tags": ["important", "urgent"]
}
```

##### request.headers

| 項目 | 値 |
|-----|-----|
| 型 | `Record<string, string>` |
| 必須 | Yes |
| 説明 | リクエストヘッダー |

```json
"headers": {
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiIs...",
  "Content-Type": "application/json",
  "X-Request-ID": "req-123456"
}
```

##### request.body

| 項目 | 値 |
|-----|-----|
| 型 | `any \| null` |
| 必須 | Yes |
| 説明 | リクエストボディ（JSONまたはnull） |

```json
// POST/PUT/PATCHの場合
"body": {
  "name": "田中太郎",
  "email": "tanaka@example.com"
}

// GET/DELETEの場合
"body": null
```

#### response

レスポンス情報を格納するオブジェクト。

| 項目 | 値 |
|-----|-----|
| 型 | `ResponseData` |
| 必須 | Yes |

##### response.status

| 項目 | 値 |
|-----|-----|
| 型 | `number` |
| 必須 | Yes |
| 説明 | HTTPステータスコード |

```json
"status": 200
```

##### response.headers

| 項目 | 値 |
|-----|-----|
| 型 | `Record<string, string>` |
| 必須 | Yes |
| 説明 | レスポンスヘッダー |

```json
"headers": {
  "Content-Type": "application/json",
  "X-Request-ID": "req-123456",
  "Cache-Control": "no-cache"
}
```

##### response.body

| 項目 | 値 |
|-----|-----|
| 型 | `any` |
| 必須 | Yes |
| 説明 | レスポンスボディ |

```json
"body": {
  "users": [
    { "id": 1, "name": "田中" },
    { "id": 2, "name": "佐藤" }
  ],
  "total": 2
}
```

### 完全な例

#### GET リクエスト

```json
{
  "endpoint": "/api/users/:id",
  "method": "GET",
  "request": {
    "pathParams": { "id": "123" },
    "queryParams": { "include": "profile,orders" },
    "headers": {
      "Authorization": "Bearer eyJhbGciOiJIUzI1NiIs...",
      "Accept": "application/json"
    },
    "body": null
  },
  "response": {
    "status": 200,
    "headers": {
      "Content-Type": "application/json",
      "X-Request-ID": "req-abc123"
    },
    "body": {
      "id": 123,
      "name": "田中太郎",
      "email": "tanaka@example.com",
      "profile": {
        "avatar": "https://example.com/avatar.png"
      },
      "orders": [
        { "id": 1, "total": 1000 }
      ]
    }
  }
}
```

#### POST リクエスト

```json
{
  "endpoint": "/api/users",
  "method": "POST",
  "request": {
    "pathParams": {},
    "queryParams": {},
    "headers": {
      "Authorization": "Bearer eyJhbGciOiJIUzI1NiIs...",
      "Content-Type": "application/json"
    },
    "body": {
      "name": "新規ユーザー",
      "email": "new@example.com",
      "password": "secret123"
    }
  },
  "response": {
    "status": 201,
    "headers": {
      "Content-Type": "application/json",
      "Location": "/api/users/456"
    },
    "body": {
      "id": 456,
      "name": "新規ユーザー",
      "email": "new@example.com",
      "createdAt": "2025-12-02T10:00:00.000Z"
    }
  }
}
```

#### エラーレスポンス

```json
{
  "endpoint": "/api/users/:id",
  "method": "GET",
  "request": {
    "pathParams": { "id": "999" },
    "queryParams": {},
    "headers": {
      "Authorization": "Bearer eyJhbGciOiJIUzI1NiIs..."
    },
    "body": null
  },
  "response": {
    "status": 404,
    "headers": {
      "Content-Type": "application/json"
    },
    "body": {
      "error": "Not Found",
      "message": "User with id 999 not found"
    }
  }
}
```

---

## state.json

### ファイル配置

```
.snaperro/
└── state.json
```

### スキーマ

```json
{
  "mode": "mock",
  "currentPattern": "正常系フル"
}
```

### フィールド詳細

#### mode

| 項目 | 値 |
|-----|-----|
| 型 | `string` |
| 必須 | Yes |
| 値 | `"proxy"` \| `"record"` \| `"mock"` |
| デフォルト | `"proxy"` |
| 説明 | 現在のサーバーモード |

#### currentPattern

| 項目 | 値 |
|-----|-----|
| 型 | `string \| null` |
| 必須 | Yes |
| デフォルト | `null` |
| 説明 | 現在選択中のパターン名 |

### 初期状態

```json
{
  "mode": "proxy",
  "currentPattern": null
}
```

### 使用例

```json
// Mockモードで「正常系フル」パターンを使用中
{
  "mode": "mock",
  "currentPattern": "正常系フル"
}

// Recordモードで「エラー系」パターンに記録中
{
  "mode": "record",
  "currentPattern": "エラー系"
}

// Proxyモード（パターン不要）
{
  "mode": "proxy",
  "currentPattern": null
}
```

---

## TypeScript型定義

```typescript
/**
 * 記録ファイルのスキーマ
 */
interface Recording {
  /** エンドポイントのパスパターン */
  endpoint: string

  /** HTTPメソッド */
  method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE' | 'OPTIONS' | 'HEAD'

  /** リクエスト情報 */
  request: RequestData

  /** レスポンス情報 */
  response: ResponseData
}

/**
 * リクエスト情報
 */
interface RequestData {
  /** パスパラメータ */
  pathParams: Record<string, string>

  /** クエリパラメータ */
  queryParams: Record<string, string | string[]>

  /** リクエストヘッダー */
  headers: Record<string, string>

  /** リクエストボディ */
  body: unknown | null
}

/**
 * レスポンス情報
 */
interface ResponseData {
  /** HTTPステータスコード */
  status: number

  /** レスポンスヘッダー */
  headers: Record<string, string>

  /** レスポンスボディ */
  body: unknown
}

/**
 * サーバー状態
 */
interface State {
  /** 現在のモード */
  mode: 'proxy' | 'record' | 'mock'

  /** 現在選択中のパターン */
  currentPattern: string | null
}
```

---

## Zodスキーマ

```typescript
import { z } from 'zod'

/**
 * リクエスト情報のスキーマ
 */
const RequestDataSchema = z.object({
  pathParams: z.record(z.string()),
  queryParams: z.record(z.union([z.string(), z.array(z.string())])),
  headers: z.record(z.string()),
  body: z.unknown().nullable(),
})

/**
 * レスポンス情報のスキーマ
 */
const ResponseDataSchema = z.object({
  status: z.number().int().min(100).max(599),
  headers: z.record(z.string()),
  body: z.unknown(),
})

/**
 * 記録ファイルのスキーマ
 */
const RecordingSchema = z.object({
  endpoint: z.string(),
  method: z.enum(['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS', 'HEAD']),
  request: RequestDataSchema,
  response: ResponseDataSchema,
})

/**
 * サーバー状態のスキーマ
 */
const StateSchema = z.object({
  mode: z.enum(['proxy', 'record', 'mock']),
  currentPattern: z.string().nullable(),
})

export { RecordingSchema, StateSchema }
```

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [内部API仕様](./2025-12-02_03_内部API仕様.md)
- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
