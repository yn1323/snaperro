# snaperro 実装修正計画

## 概要

既存実装をベースに、新しい仕様に合わせてサーバーを修正・拡張する。
ドキュメント作成完了。以下、実装修正計画。

---

## 現行実装 vs 新仕様の差分サマリ

### 1. ファイル命名規則（大幅変更）
| 項目 | 現行 | 新仕様 |
|-----|------|-------|
| 構造 | `{pattern}/{path}/{METHOD}_{count}.json` | `{pattern}/{endpoint}_{count}.json` |
| 例 | `demo/api/users/GET_1.json` | `正常系フル/api_users_001.json` |
| パス | ディレクトリ構造 | アンダースコア連結 |
| メソッド | ファイル名に含む | JSON内部に保持 |
| 連番 | 1桁〜 | 3桁0埋め |

### 2. マッチングロジック（大幅変更）
| 項目 | 現行 | 新仕様 |
|-----|------|-------|
| パターン形式 | Globパターン `/**` | ルートパターン `:id` |
| 設定キー | `match: []` | `routes: []` |
| パスパラメータ | なし | `{id}` として抽出・保存 |
| Mockマッチング | 連番順 | リクエストパラメータ完全一致 |

### 3. JSONファイル構造（変更）
| 項目 | 現行 | 新仕様 |
|-----|------|-------|
| endpoint | `request.url` | トップレベル `endpoint` |
| method | `request.method` | トップレベル `method` |
| pathParams | なし | `request.pathParams` |
| queryParams | なし | `request.queryParams` |
| recordedAt | あり | なし |

### 4. State管理（変更）
| 項目 | 現行 | 新仕様 |
|-----|------|-------|
| 永続化 | なし（メモリのみ） | `.snaperro/state.json` |
| counter | あり | なし（パラメータマッチング） |

### 5. 内部API（拡張）
- HTTPメソッド変更（POST → GET/PUT/DELETE）
- 新規エンドポイント追加（複製、リネーム、ダウンロード、アップロード）

---

## 修正対象ファイル一覧

### Phase 1: Core（基盤）
| ファイル | 修正内容 | 優先度 |
|---------|---------|-------|
| `src/types/config.ts` | `match` → `routes` 変更、スキーマ更新 | 高 |
| `src/types/recording.ts` | JSONスキーマ全面変更 | 高 |
| `src/core/state.ts` | 永続化追加、counter削除 | 高 |
| `src/core/storage.ts` | ファイル命名規則変更、パス変換ロジック | 高 |
| `src/core/matcher.ts` | Glob → ルートパターン、パスパラメータ抽出 | 高 |

### Phase 2: Server（サーバー）
| ファイル | 修正内容 | 優先度 |
|---------|---------|-------|
| `src/server/recorder.ts` | 新JSON構造、パラメータ抽出、上書きロジック | 高 |
| `src/server/mocker.ts` | パラメータマッチング、404レスポンス | 高 |
| `src/server/proxy.ts` | 軽微な修正のみ | 低 |
| `src/server/handler.ts` | matcher変更に伴う調整 | 中 |
| `src/server/control-api.ts` | API全面刷新 | 高 |

### Phase 3: CLI
| ファイル | 修正内容 | 優先度 |
|---------|---------|-------|
| `src/cli/commands/init.ts` | state.json生成追加 | 中 |
| `src/cli/commands/start.ts` | 状態復元ロジック | 中 |

### Phase 4: Tests
| ファイル | 修正内容 | 優先度 |
|---------|---------|-------|
| `src/core/*.test.ts` | 全テスト更新 | 中 |
| `src/server/*.test.ts` | 全テスト更新 | 中 |

---

## 実装順序（依存関係考慮）

### Step 1: 型定義の更新
1. `src/types/recording.ts` - 新JSONスキーマ定義
2. `src/types/config.ts` - `routes`フィールド追加

### Step 2: コア機能の更新
3. `src/core/matcher.ts` - ルートパターンマッチング実装
4. `src/core/storage.ts` - 新ファイル命名規則実装
5. `src/core/state.ts` - 永続化実装

### Step 3: サーバーの更新
6. `src/server/recorder.ts` - 新記録ロジック
7. `src/server/mocker.ts` - 新マッチングロジック
8. `src/server/handler.ts` - 統合調整
9. `src/server/control-api.ts` - 内部API全面刷新

### Step 4: CLI更新
10. `src/cli/commands/init.ts` - state.json生成
11. `src/cli/commands/start.ts` - 状態復元

### Step 5: テスト更新
12. 全テストファイルを新仕様に合わせて更新

---

## 詳細実装計画

### Step 1-1: src/types/recording.ts

**変更前:**
```typescript
{
  request: { method, url, headers, body? },
  response: { status, headers, body },
  recordedAt: string
}
```

**変更後:**
```typescript
{
  endpoint: string,           // "/api/users/:id"
  method: string,             // "GET"
  request: {
    pathParams: Record<string, string>,
    queryParams: Record<string, string | string[]>,
    headers: Record<string, string>,
    body: unknown | null
  },
  response: {
    status: number,
    headers: Record<string, string>,
    body: unknown
  }
}
```

### Step 1-2: src/types/config.ts

**変更:**
- `match: string[]` → `routes: string[]`
- routeパターンのバリデーション追加

### Step 2-1: src/core/matcher.ts

**新機能:**
- `:param` 形式のルートパターン解析
- パスパラメータ抽出 (`/api/users/123` → `{id: "123"}`)
- マッチ結果にパスパラメータを含める

```typescript
interface MatchResult {
  api: ApiConfig
  pathParams: Record<string, string>
}
```

### Step 2-2: src/core/storage.ts

**変更:**
- `buildFilePath`: パスをアンダースコア連結
- 連番を3桁0埋め
- パスパラメータは `{param}` 形式でファイル名に

**新規:**
- `findMatchingFile`: パラメータマッチングでファイル検索
- `findNextSequence`: 次の連番を取得
- zipダウンロード/アップロード用メソッド

### Step 2-3: src/core/state.ts

**変更:**
- counter削除
- `save()`: state.jsonへ書き込み
- `load()`: state.jsonから読み込み
- サーバー起動時に自動ロード

### Step 3-1: src/server/recorder.ts

**変更:**
- パスパラメータ抽出してJSON保存
- クエリパラメータ抽出
- 同一パラメータのファイル上書き
- 新規パラメータは新ファイル

### Step 3-2: src/server/mocker.ts

**変更:**
- パラメータマッチングでファイル検索
- マッチなしは404エラー
- counter使用廃止

### Step 3-3: src/server/control-api.ts

**全面刷新:**
- HTTPメソッド変更（REST準拠）
- 新エンドポイント追加
- レスポンス形式統一

---

## リスク・注意点

1. **後方互換性なし**: 既存の記録ファイルは新形式と互換性がない
2. **設定ファイル変更**: `match` → `routes` の変更が必要
3. **テスト全更新**: 全テストファイルの更新が必要

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [内部API仕様](./2025-12-02_03_内部API仕様.md)
- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
- [JSONスキーマ仕様](./2025-12-02_06_JSONスキーマ仕様.md)
