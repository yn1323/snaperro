# RESTful API 変更仕様

## 概要

Files APIをRESTful設計に変更し、ステートレスなAPI設計を実現する。

---

## 変更の背景

### 現状の問題点

現在のFiles APIは、サーバー側の`state.getPattern()`に依存している：

```typescript
// 現在の実装
controlApi.get("/files/:filename", async (c) => {
  const pattern = state.getPattern();  // サーバー側stateに依存
  const filePath = `${pattern}/${filename}`;
  // ...
});
```

これはREST原則に違反している：

| REST原則 | 現在の設計 | 問題 |
|---------|----------|-----|
| ステートレス | サーバー側stateに依存 | クライアントのリクエストだけでリソースを特定できない |
| URIでリソース識別 | `/files/:filename` | パターンが不明なため一意に特定できない |

### 改善後

URLにパターン名を含めることで、リクエストのみでリソースを一意に特定可能にする。

---

## 変更点サマリー

### Before（Stateful）

| メソッド | パス |
|---------|------|
| GET | `/__snaperro__/files` |
| GET | `/__snaperro__/files/:filename` |
| GET | `/__snaperro__/files/:filename/download` |
| POST | `/__snaperro__/files/upload` |
| PUT | `/__snaperro__/files/:filename` |
| DELETE | `/__snaperro__/files/:filename` |

### After（RESTful）

| メソッド | パス |
|---------|------|
| GET | `/__snaperro__/patterns/:pattern/files` |
| GET | `/__snaperro__/patterns/:pattern/files/:filename` |
| GET | `/__snaperro__/patterns/:pattern/files/:filename/download` |
| POST | `/__snaperro__/patterns/:pattern/files/upload` |
| PUT | `/__snaperro__/patterns/:pattern/files/:filename` |
| DELETE | `/__snaperro__/patterns/:pattern/files/:filename` |

---

## 新しいエンドポイント詳細

### GET /__snaperro__/patterns/:pattern/files

指定パターン内の記録ファイル一覧を取得する。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| pattern | パターン名 |

**レスポンス**

```json
{
  "pattern": "正常系フル",
  "files": [
    {
      "filename": "api_users_001.json",
      "endpoint": "/api/users",
      "method": "GET",
      "size": 1024,
      "updatedAt": "2025-12-02T12:00:00.000Z"
    }
  ]
}
```

**エラーレスポンス**

```json
{
  "error": "Not found",
  "resource": "pattern",
  "name": "存在しないパターン"
}
```

---

### GET /__snaperro__/patterns/:pattern/files/:filename

記録ファイルの内容を取得する。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| pattern | パターン名 |
| filename | ファイル名（例: `api_users_001.json`） |

**レスポンス**

```json
{
  "endpoint": "/api/users",
  "method": "GET",
  "request": {
    "pathParams": {},
    "queryParams": { "status": "active" },
    "headers": { "Authorization": "Bearer xxx" },
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": {
      "users": [{ "id": 1, "name": "田中" }]
    }
  }
}
```

---

### GET /__snaperro__/patterns/:pattern/files/:filename/download

記録ファイルを個別にダウンロードする。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| pattern | パターン名 |
| filename | ファイル名 |

**レスポンス**

- Content-Type: `application/json`
- Content-Disposition: `attachment; filename="api_users_001.json"`
- Body: JSONファイルの内容

---

### POST /__snaperro__/patterns/:pattern/files/upload

記録ファイルをアップロードする。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| pattern | パターン名 |

**リクエスト**

- Content-Type: `multipart/form-data`
- Body:
  - `file`: JSONファイル

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "File uploaded"
}
```

---

### PUT /__snaperro__/patterns/:pattern/files/:filename

記録ファイルの内容を編集する。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| pattern | パターン名 |
| filename | ファイル名 |

**リクエスト**

```json
{
  "endpoint": "/api/users",
  "method": "GET",
  "request": {
    "pathParams": {},
    "queryParams": { "status": "active" },
    "headers": {},
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": { "users": [] }
  }
}
```

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "File updated"
}
```

---

### DELETE /__snaperro__/patterns/:pattern/files/:filename

記録ファイルを削除する。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| pattern | パターン名 |
| filename | ファイル名 |

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "File deleted"
}
```

---

## 共通エラーレスポンス

### パターンが存在しない場合（404）

```json
{
  "error": "Not found",
  "resource": "pattern",
  "name": "存在しないパターン"
}
```

### ファイルが存在しない場合（404）

```json
{
  "error": "Not found",
  "resource": "file",
  "filename": "api_users_999.json"
}
```

---

## 影響範囲

### 修正が必要なファイル

| ファイル | 変更内容 |
|---------|---------|
| `server/handlers/control-api.ts` | エンドポイントのパス変更、state依存の削除 |
| `server/handlers/control-api.test.ts` | テストのパス修正 |
| `debug/postman-collection.json` | 新しいエンドポイントに更新 |
| `doc/2025-12-02_03_内部API仕様.md` | 仕様書の更新 |

### 変更不要なファイル

| ファイル | 理由 |
|---------|-----|
| `server/handlers/mocker.ts` | プロキシ動作時のstate依存は維持（GUIとの連携用） |
| `server/handlers/recorder.ts` | 記録動作時のstate依存は維持（GUIとの連携用） |
| `server/core/state.ts` | state管理自体は維持 |

---

## 関連ドキュメント

- [内部API仕様](./2025-12-02_03_内部API仕様.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
