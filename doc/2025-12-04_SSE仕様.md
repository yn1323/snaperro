# snaperro SSE (Server-Sent Events) 仕様

## 概要

snaperroサーバーは、GUIがリアルタイムで状態変更を検知するためのSSEエンドポイントを提供します。
記録モードでファイルが追加された際など、即座にGUIに反映させることができます。

---

## エンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/events` | SSEイベントストリーム |

---

## 接続方法

### クライアント側（JavaScript）

```javascript
const eventSource = new EventSource("http://localhost:3333/__snaperro__/events");

// 接続完了時（初期状態を受信）
eventSource.addEventListener("connected", (e) => {
  const data = JSON.parse(e.data);
  console.log("Connected:", data);
  // { mode, currentPattern, patterns, files }
});

// モード変更
eventSource.addEventListener("mode_changed", (e) => {
  const { mode } = JSON.parse(e.data);
  console.log("Mode changed:", mode);
});

// パターン切替
eventSource.addEventListener("pattern_changed", (e) => {
  const { pattern } = JSON.parse(e.data);
  console.log("Pattern changed:", pattern);
});

// ファイル作成（記録時）
eventSource.addEventListener("file_created", (e) => {
  const { pattern, filename, endpoint, method } = JSON.parse(e.data);
  console.log("File created:", filename);
});

// エラー処理
eventSource.onerror = (e) => {
  console.error("SSE error:", e);
  // 自動再接続される
};

// 接続終了
eventSource.close();
```

---

## イベント種別

### connected

接続完了時に送信される初期状態。

```json
{
  "mode": "mock",
  "currentPattern": "正常系フル",
  "patterns": ["正常系フル", "空データ", "エラー系"],
  "files": [
    {
      "filename": "api_users_001.json",
      "endpoint": "/api/users",
      "method": "GET"
    }
  ]
}
```

### mode_changed

モードが変更された時。

```json
{
  "mode": "record"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| mode | string | 新しいモード（proxy/record/mock） |

### pattern_changed

現在のパターンが変更された時。

```json
{
  "pattern": "エラー系"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| pattern | string \| null | 新しいパターン名 |

### pattern_created

新規パターンが作成された時。

```json
{
  "name": "新規パターン"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| name | string | 作成されたパターン名 |

### pattern_deleted

パターンが削除された時。

```json
{
  "name": "削除パターン"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| name | string | 削除されたパターン名 |

### pattern_renamed

パターン名が変更された時。

```json
{
  "oldName": "旧名",
  "newName": "新名"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| oldName | string | 変更前のパターン名 |
| newName | string | 変更後のパターン名 |

### file_created

新規ファイルが作成された時（主に記録モードで発生）。

```json
{
  "pattern": "正常系フル",
  "filename": "api_users_001.json",
  "endpoint": "/api/users",
  "method": "GET"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| pattern | string | パターン名 |
| filename | string | ファイル名 |
| endpoint | string | エンドポイント |
| method | string | HTTPメソッド |

### file_updated

既存ファイルが更新された時。

```json
{
  "pattern": "正常系フル",
  "filename": "api_users_001.json",
  "endpoint": "/api/users",
  "method": "GET"
}
```

フィールドは `file_created` と同じ。

### file_deleted

ファイルが削除された時。

```json
{
  "pattern": "正常系フル",
  "filename": "api_users_001.json"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| pattern | string | パターン名 |
| filename | string | 削除されたファイル名 |

---

## 接続・再接続の挙動

### 自動再接続

SSE（EventSource API）は接続が切れた場合、ブラウザが自動的に再接続を試みます。
再接続時は `connected` イベントで最新の状態が送信されます。

### Keep-Alive

サーバーは30秒ごとにコメントを送信して接続を維持します。

### 推奨実装パターン

```javascript
function connectSSE() {
  const eventSource = new EventSource("/__snaperro__/events");

  eventSource.addEventListener("connected", (e) => {
    const state = JSON.parse(e.data);
    // UIを初期状態で更新
    updateUI(state);
  });

  eventSource.addEventListener("file_created", (e) => {
    const file = JSON.parse(e.data);
    // ファイル一覧に追加
    addFileToList(file);
  });

  eventSource.addEventListener("pattern_created", (e) => {
    const { name } = JSON.parse(e.data);
    // パターン一覧に追加
    addPatternToList(name);
  });

  // 他のイベントも同様に...

  eventSource.onerror = () => {
    // 自動再接続されるので、特別な処理は不要
    // 必要に応じてUIに「再接続中...」を表示
  };

  return eventSource;
}

// 使用例
const sse = connectSSE();

// ページ離脱時にクリーンアップ
window.addEventListener("beforeunload", () => {
  sse.close();
});
```

---

## React Hooks での利用例

```typescript
import { useEffect, useState } from "react";

interface SnaperroState {
  mode: string;
  currentPattern: string | null;
  patterns: string[];
  files: Array<{ filename: string; endpoint: string; method: string }>;
}

export function useSnaperroSSE(baseUrl = "http://localhost:3333") {
  const [state, setState] = useState<SnaperroState | null>(null);
  const [connected, setConnected] = useState(false);

  useEffect(() => {
    const eventSource = new EventSource(`${baseUrl}/__snaperro__/events`);

    eventSource.addEventListener("connected", (e) => {
      setState(JSON.parse(e.data));
      setConnected(true);
    });

    eventSource.addEventListener("mode_changed", (e) => {
      const { mode } = JSON.parse(e.data);
      setState((prev) => (prev ? { ...prev, mode } : null));
    });

    eventSource.addEventListener("pattern_changed", (e) => {
      const { pattern } = JSON.parse(e.data);
      setState((prev) => (prev ? { ...prev, currentPattern: pattern } : null));
    });

    eventSource.addEventListener("file_created", (e) => {
      const file = JSON.parse(e.data);
      setState((prev) =>
        prev ? { ...prev, files: [...prev.files, file] } : null
      );
    });

    eventSource.onerror = () => {
      setConnected(false);
    };

    return () => {
      eventSource.close();
    };
  }, [baseUrl]);

  return { state, connected };
}
```

---

## 動作確認方法

### curlで確認

```bash
curl -N http://localhost:3333/__snaperro__/events
```

`-N` オプションでバッファリングを無効にし、リアルタイムでイベントを受信できます。

### ブラウザコンソールで確認

```javascript
const es = new EventSource("http://localhost:3333/__snaperro__/events");
es.addEventListener("connected", (e) => console.log("connected:", JSON.parse(e.data)));
es.addEventListener("file_created", (e) => console.log("file_created:", JSON.parse(e.data)));
es.onerror = (e) => console.error("error:", e);
```

### 注意

PostmanはSSE (Server-Sent Events) をネイティブでサポートしていません。
上記のcurlまたはブラウザコンソールでの確認を推奨します。

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [内部API仕様](./2025-12-02_03_内部API仕様.md)
