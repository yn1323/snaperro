# リファクタリング実装計画

## 概要

Server/Client のコード品質向上を目的としたリファクタリング計画。

### 方針
1. **Shared**: 型定義を `shared/` ディレクトリに抽出
2. **Server**: 重複コードの共通化
3. **Client**: カスタムフック切り出し + 重複コード共通化

---

## Phase 1: Shared型定義の抽出（基盤作業）

他のPhaseの前提となるため最初に実施。

### Task 1.1: shared/ ディレクトリの作成

**新規作成:**
```
shared/
├── types/
│   ├── index.ts      # 再エクスポート
│   ├── mode.ts       # Mode型 + Zodスキーマ
│   ├── file.ts       # FileData関連型
│   └── sse.ts        # SSEイベント型
```

**mode.ts:**
```typescript
import { z } from "zod/v4";
export const ModeSchema = z.enum(["proxy", "record", "mock"]);
export type Mode = z.infer<typeof ModeSchema>;
```

**file.ts:** server/types/file.ts の内容を移動

**sse.ts:** server/types/sse.ts の内容を移動

### Task 1.2: TypeScript設定の更新

**変更対象:**
- `tsconfig.json` - paths エイリアス追加
- `tsup.config.ts` - エントリーポイント追加

### Task 1.3: 既存ファイルの更新

| ファイル | 変更内容 |
|----------|----------|
| `server/types/file.ts` | shared への re-export |
| `server/types/sse.ts` | shared への re-export |
| `server/core/state.ts` | Mode型をsharedからimport |
| `client/src/types/index.ts` | sharedからimportに変更 |
| `server/index.ts` | export元の更新 |

---

## Phase 2: Server側の重複コード共通化

### Task 2.1: リクエスト処理ユーティリティの作成

**新規作成:** `server/core/request-utils.ts`

| 関数 | 元の場所 |
|------|----------|
| `parseQueryParams()` | recorder.ts:15-26, mocker.ts:13-24 |
| `parseRequestBody()` | recorder.ts:54-64, mocker.ts:50-61, proxy.ts:22-26 |
| `copyRequestHeaders()` | recorder.ts:67-83, proxy.ts:29-45 |

```typescript
// parseQueryParams
export function parseQueryParams(url: URL): Record<string, string | string[]>

// parseRequestBody
export async function parseRequestBody(
  method: string,
  getText: () => Promise<string>
): Promise<unknown | null>

// copyRequestHeaders
export function copyRequestHeaders(
  sourceHeaders: Headers,
  additionalHeaders?: Record<string, string>,
  skipHeaders?: string[]
): Headers
```

### Task 2.2: ハンドラーファイルの更新

**変更対象:**
- `server/handlers/recorder.ts`
- `server/handlers/mocker.ts`
- `server/handlers/proxy.ts`

### Task 2.3: エラーレスポンスの統一（任意）

**新規作成:** `server/core/api-response.ts`

```typescript
export function notFoundError(resource: string, name: string): ApiError
export function validationError(details: string): ApiError
export function conflictError(resource: string, name: string): ApiError
```

**変更対象:** `server/handlers/control-api.ts`

---

## Phase 3: Client側のリファクタリング

### Task 3.1: App.tsxからカスタムフックの切り出し

**新規作成:** `client/src/hooks/useFileEditor.ts`

App.tsxから抽出する状態とハンドラー:
- `selectedFile`, `fileData`, `isLoadingFile`, `deleteFileTarget`
- ファイル読み込みの useEffect
- `handleFileSave`, `handleFileDelete`, `handleFileDeleteConfirm`
- `handleFileUpload`, `handleFileDownload`

```typescript
interface UseFileEditorReturn {
  selectedFile: string | null;
  setSelectedFile: (file: string | null) => void;
  fileData: FileData | null;
  isLoadingFile: boolean;
  deleteFileTarget: string | null;
  handleFileSave: (data: FileData) => Promise<void>;
  handleFileDelete: () => void;
  handleFileDeleteConfirm: () => Promise<void>;
  handleFileUpload: (file: File) => Promise<void>;
  handleFileDownload: (filename: string) => Promise<void>;
  resetFileSelection: () => void;
  closeDeleteConfirm: () => void;
}
```

**新規作成:** `client/src/hooks/usePatternNavigation.ts`

App.tsxから抽出:
- `currentFolder`
- `handleFolderSelect`, `handleFolderBack`, `handlePatternSelect`

```typescript
interface UsePatternNavigationReturn {
  currentFolder: string | null;
  handleFolderSelect: (folder: string) => void;
  handleFolderBack: () => Promise<void>;
  handlePatternSelect: (pattern: string) => Promise<void>;
}
```

### Task 3.2: エラーハンドリングの共通化

**新規作成:** `client/src/utils/error-handler.ts`

```typescript
export async function withErrorHandling<T>(
  fn: () => Promise<T>,
  errorMessage: string
): Promise<T | undefined>

export function createSafeHandler<Args extends unknown[], T>(
  fn: (...args: Args) => Promise<T>,
  errorMessage: string
): (...args: Args) => Promise<T | undefined>
```

### Task 3.3: 作成モーダルの共通化

**新規作成:** `client/src/components/dialogs/CreateModal.tsx`

```typescript
interface CreateModalProps {
  isOpen: boolean;
  title: string;
  placeholder: string;
  submitLabel?: string;
  onClose: () => void;
  onCreate: (name: string) => void;
}
```

**変更対象:**
- `CreatePatternModal.tsx` - CreateModal を使用
- `CreateFolderModal.tsx` - CreateModal を使用

### Task 3.4: ダウンロード処理の共通化

**新規作成:** `client/src/utils/download.ts`

```typescript
export async function downloadAsFile(url: string, filename: string): Promise<void>
```

**変更対象:** `client/src/hooks/useSnaperroAPI.ts`

---

## 実行順序

```
Phase 1 (基盤) ─────────────────────────────────────┐
├── Task 1.1: shared/ ディレクトリ作成              │
├── Task 1.2: TypeScript設定更新                    │
└── Task 1.3: 既存ファイル更新                      │
                                                    ▼
┌─────────────────────────┬─────────────────────────┐
│ Phase 2 (Server)        │ Phase 3 (Client)        │
├─────────────────────────┼─────────────────────────┤
│ Task 2.1: request-utils │ Task 3.3: モーダル共通化│
│ Task 2.2: handler更新   │ Task 3.4: download共通化│
│ Task 2.3: api-response  │ Task 3.2: エラー共通化  │
│                         │ Task 3.1: カスタムフック│
└─────────────────────────┴─────────────────────────┘
```

Phase 2 と Phase 3 は並行実施可能。

---

## 変更対象ファイル一覧

### 新規作成
| パス | 説明 |
|------|------|
| `shared/types/index.ts` | 型の再エクスポート |
| `shared/types/mode.ts` | Mode型定義 |
| `shared/types/file.ts` | FileData関連型 |
| `shared/types/sse.ts` | SSEイベント型 |
| `server/core/request-utils.ts` | リクエスト処理ユーティリティ |
| `server/core/request-utils.test.ts` | テスト |
| `server/core/api-response.ts` | エラーレスポンスヘルパー |
| `client/src/hooks/useFileEditor.ts` | ファイル編集フック |
| `client/src/hooks/usePatternNavigation.ts` | ナビゲーションフック |
| `client/src/utils/error-handler.ts` | エラーハンドリング |
| `client/src/utils/download.ts` | ダウンロード処理 |
| `client/src/components/dialogs/CreateModal.tsx` | 共通モーダル |

### 変更
| パス | 変更内容 |
|------|----------|
| `tsconfig.json` | paths追加 |
| `tsup.config.ts` | エントリーポイント追加 |
| `server/types/file.ts` | sharedへのre-export |
| `server/types/sse.ts` | sharedへのre-export |
| `server/core/state.ts` | import元変更 |
| `server/handlers/recorder.ts` | ユーティリティ使用 |
| `server/handlers/mocker.ts` | ユーティリティ使用 |
| `server/handlers/proxy.ts` | ユーティリティ使用 |
| `server/handlers/control-api.ts` | エラーレスポンス統一 |
| `server/index.ts` | export元更新 |
| `client/src/types/index.ts` | sharedからimport |
| `client/src/App.tsx` | フック使用に変更 |
| `client/src/hooks/useSnaperroAPI.ts` | download共通化 |
| `client/src/components/CreatePatternModal.tsx` | 共通モーダル使用 |
| `client/src/components/CreateFolderModal.tsx` | 共通モーダル使用 |

---

## テスト戦略

各Phase完了後に実行:
```bash
pnpm type-check && pnpm format && pnpm test
```

Phase 3 完了後はGUIの手動動作確認も実施。
