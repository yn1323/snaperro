# 検索機能強化仕様

## 概要

現在のFilePane検索機能を強化し、ファイル名・エンドポイントだけでなく、JSONファイルの中身（レスポンスボディなど）も検索対象に含める。また、EditorPaneで検索文字列を黄色でハイライト表示する。

## 現状の検索機能

### 検索対象
- `filename` - ファイル名
- `endpoint` - APIエンドポイント

### 検索方式
- クライアント側でローカルフィルタリング（`useMemo`）
- リアルタイム検索（入力直後に即座に反映）
- ケースインセンシティブ（大文字小文字を区別しない）

### 実装場所
- `client/src/components/FilePane.tsx` (65-77行目)

## 新機能仕様

### 1. ファイル内コンテンツ検索

#### 検索対象の拡張
- ファイル全体（JSONテキスト全体を対象にテキスト検索）
- JSONパースなしでテキスト検索を行うため高速

#### 検索方式
- サーバー側検索API方式を採用
- クライアントからAPIを呼び出し、サーバーでファイル内容を検索
- デバウンス検索（300ms）でAPIリクエスト数を削減

### 2. EditorPaneハイライト機能

#### 表示方式
- 検索文字列を黄色（`background: yellow`）でハイライト
- オーバーレイ方式で実装（編集機能を維持）

---

## 実装フェーズ

### フェーズ1: サーバー側API実装

**目標**: 検索APIエンドポイントを追加し、パターン内ファイルの全文検索機能を実装

#### 修正ファイル
| ファイル | 変更内容 |
|---------|---------|
| `server/core/storage.ts` | `searchPatternFiles` 関数追加 |
| `server/handlers/control-api.ts` | `/patterns/:pattern/files/search` エンドポイント追加 |

#### 実装内容

**storage.ts - 検索関数**

```typescript
interface SearchResult {
  filename: string;
  endpoint: string;
  method: string;
}

/**
 * パターン内のファイルを検索
 * @param pattern パターン名
 * @param query 検索クエリ
 * @returns マッチしたファイルの配列
 */
async searchPatternFiles(pattern: string, query: string): Promise<SearchResult[]>
```

実装ポイント:
- パターン内の全JSONファイルを走査
- ファイル内容をそのままテキスト検索（`content.toLowerCase().includes(query.toLowerCase())`）
- JSONパースは基本情報（endpoint, method）取得時のみ
- ケースインセンシティブ検索

**control-api.ts - エンドポイント**

```typescript
controlApi.get("/patterns/:pattern/files/search", async (c) => {
  const pattern = c.req.param("pattern");
  const query = c.req.query("q");

  if (!query) {
    return c.json({ error: "Query required" }, 400);
  }

  if (!(await storage.patternExists(pattern))) {
    return c.json({ error: "Not found", resource: "pattern", name: pattern }, 404);
  }

  const results = await storage.searchPatternFiles(pattern, query);
  return c.json({ pattern, query, files: results });
});
```

#### 確認方法
```bash
# サーバー起動後、curlでテスト
curl "http://localhost:3000/__snaperro__/patterns/folder%2Fpattern/files/search?q=test"
```

---

### フェーズ2: クライアント側検索機能

**目標**: FilePaneからサーバー検索APIを呼び出し、ファイル内コンテンツ検索を有効化

#### 修正ファイル
| ファイル | 変更内容 |
|---------|---------|
| `client/src/types/index.ts` | `SearchResult` 型追加 |
| `client/src/hooks/useSnaperroAPI.ts` | `searchFiles` 関数追加 |
| `client/src/components/FilePane.tsx` | 検索ロジック更新、props に pattern 追加 |
| `client/src/App.tsx` | FilePane に pattern props を渡す |

#### 実装内容

**types/index.ts - 型定義**

```typescript
export interface SearchResult {
  filename: string;
  endpoint: string;
  method: string;
}
```

**useSnaperroAPI.ts - API関数**

```typescript
searchFiles: async (pattern: string, query: string): Promise<SearchResult[]> => {
  const res = await fetch(`${baseUrl}/patterns/${encodeURIComponent(pattern)}/files/search?q=${encodeURIComponent(query)}`);
  if (!res.ok) throw new Error("Search failed");
  const data = await res.json();
  return data.files;
}
```

**FilePane.tsx - 検索ロジック**

変更内容:
1. `pattern` を props に追加（検索APIに必要）
2. デバウンス検索（300ms）を実装
3. 空クエリ: 既存のローカルフィルタ
4. クエリあり: サーバーAPIを呼び出し
5. 検索中インジケータ表示

```typescript
interface FilePaneProps {
  // ... 既存のprops
  pattern: string | null;  // 追加
}

// デバウンス検索
const [searchResults, setSearchResults] = useState<SearchResult[] | null>(null);
const [isSearching, setIsSearching] = useState(false);

useEffect(() => {
  if (!searchQuery.trim() || !pattern) {
    setSearchResults(null);
    return;
  }

  const timer = setTimeout(async () => {
    setIsSearching(true);
    try {
      const results = await api.searchFiles(pattern, searchQuery);
      setSearchResults(results);
    } finally {
      setIsSearching(false);
    }
  }, 300);

  return () => clearTimeout(timer);
}, [searchQuery, pattern, api]);
```

**App.tsx - props追加**

```typescript
<FilePane
  // ... 既存のprops
  pattern={currentPattern}  // 追加
/>
```

#### 確認方法
- GUIで検索欄にファイル内のテキストを入力
- マッチしたファイルのみが表示されることを確認

---

### フェーズ3: EditorPaneハイライト機能

**目標**: EditorPaneで検索文字列を黄色でハイライト表示（編集機能は維持）

#### 修正ファイル
| ファイル | 変更内容 |
|---------|---------|
| `client/src/components/FilePane.tsx` | searchQuery を親に公開（コールバック追加） |
| `client/src/components/EditorPane.tsx` | 検索ハイライト機能追加 |
| `client/src/App.tsx` | searchQuery 状態をリフトアップ、EditorPane に props を渡す |

#### 実装内容

**App.tsx - searchQuery状態リフトアップ**

```typescript
const [searchQuery, setSearchQuery] = useState("");

<FilePane
  // ... 既存のprops
  searchQuery={searchQuery}
  onSearchQueryChange={setSearchQuery}
/>

<EditorPane
  // ... 既存のprops
  searchQuery={searchQuery}
/>
```

**FilePane.tsx - searchQuery を親から受け取る**

```typescript
interface FilePaneProps {
  // ... 既存のprops
  searchQuery: string;
  onSearchQueryChange: (query: string) => void;
}

// 内部state削除、propsを使用
// const [searchQuery, setSearchQuery] = useState("");  // 削除
```

**EditorPane.tsx - ハイライト機能**

変更内容:
1. `searchQuery` を props に追加
2. オーバーレイ方式でハイライト実装

```typescript
interface EditorPaneProps {
  // ... 既存のprops
  searchQuery?: string;  // 追加
}

// 正規表現エスケープ
function escapeRegExp(string: string): string {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ハイライト関数
function highlightText(text: string, query: string): React.ReactNode {
  if (!query) return text;
  const parts = text.split(new RegExp(`(${escapeRegExp(query)})`, 'gi'));
  return parts.map((part, i) =>
    part.toLowerCase() === query.toLowerCase()
      ? <mark key={i} style={{ background: 'yellow', color: 'black' }}>{part}</mark>
      : part
  );
}
```

オーバーレイ構造:
```tsx
<Box position="relative" flex={1}>
  {/* 背景: ハイライト表示用 */}
  <Box
    as="pre"
    position="absolute"
    inset={0}
    p={4}
    fontFamily="mono"
    fontSize="sm"
    bg="gray.900"
    color="gray.100"
    whiteSpace="pre-wrap"
    wordBreak="break-word"
    overflow="auto"
    pointerEvents="none"
  >
    {highlightText(editedContent, searchQuery)}
  </Box>

  {/* 前面: 編集用Textarea（透明背景） */}
  <Textarea
    value={editedContent}
    onChange={(e) => handleContentChange(e.target.value)}
    position="relative"
    bg="transparent"
    color="transparent"
    caretColor="white"
    // ... 他のスタイル
  />
</Box>
```

#### 確認方法
- GUIで検索欄に文字列を入力
- ファイルを選択してEditorPaneを表示
- 検索文字列が黄色でハイライトされていることを確認
- ハイライト状態でも編集が可能なことを確認

---

## API仕様

### 検索エンドポイント

```
GET /__snaperro__/patterns/:pattern/files/search?q=<query>
```

#### パラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `pattern` | string | Yes | パターン名（URLパス） |
| `q` | string | Yes | 検索クエリ（クエリパラメータ） |

#### レスポンス

```json
{
  "pattern": "folder/pattern",
  "query": "Alice",
  "files": [
    {
      "filename": "api_users_{id}_001.json",
      "endpoint": "/api/users/:id",
      "method": "GET"
    }
  ]
}
```

#### エラーレスポンス

パターンが存在しない場合:
```json
{
  "error": "Not found",
  "resource": "pattern",
  "name": "folder/pattern"
}
```

クエリが指定されていない場合:
```json
{
  "error": "Query required"
}
```

---

## 修正対象ファイル一覧（全体）

| フェーズ | ファイル | 変更内容 |
|---------|---------|---------|
| 1 | `server/core/storage.ts` | `searchPatternFiles` 関数追加 |
| 1 | `server/handlers/control-api.ts` | `/patterns/:pattern/files/search` エンドポイント追加 |
| 2 | `client/src/types/index.ts` | `SearchResult` 型追加 |
| 2 | `client/src/hooks/useSnaperroAPI.ts` | `searchFiles` 関数追加 |
| 2 | `client/src/components/FilePane.tsx` | 検索ロジック更新、props に pattern 追加 |
| 2 | `client/src/App.tsx` | FilePane に pattern props を渡す |
| 3 | `client/src/components/FilePane.tsx` | searchQuery を親から受け取るよう変更 |
| 3 | `client/src/components/EditorPane.tsx` | 検索ハイライト機能追加 |
| 3 | `client/src/App.tsx` | searchQuery 状態リフトアップ、EditorPane に props を渡す |

---

## 動作フロー

```
1. ユーザーがFilePaneの検索欄に入力
   ↓
2. 300ms デバウンス
   ↓
3. 空クエリ → ローカルフィルタ（既存動作）
   クエリあり → サーバーAPIを呼び出し
   ↓
4. サーバーで全ファイルをテキスト検索
   ↓
5. マッチしたファイル一覧を返却
   ↓
6. FilePaneで検索結果を表示
   ↓
7. ファイル選択時、EditorPaneで検索文字列をハイライト
```

---

## パフォーマンス考慮

- **サーバー側検索**: クライアントで全ファイルを取得するより効率的
- **テキスト検索**: JSONパースなしで高速
- **デバウンス**: APIリクエスト数を削減（300ms）
- **ケースインセンシティブ**: `toLowerCase()` で統一
