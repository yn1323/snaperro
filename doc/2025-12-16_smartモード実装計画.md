# smartモード実装計画

## 概要

既存mockがあれば返し、なければproxy&recordする「smartモード」を追加する。
開発中に無駄なAPI接続を防ぎながら、新しいエンドポイントは自動で記録する。

## 背景・目的

- proxy/recordモードで既存mockがあるのに気づかず実サーバーに接続し続ける問題を解決
- API接続回数の削減（レート制限、コスト対策）
- 開発効率の向上（意識せずに最適な動作）

## smartモード仕様

### 基本動作フロー

```
リクエスト受信
    ↓
パターン選択済み？ ─No→ エラー400
    ↓ Yes
既存mockを検索（storage.findMatchingFile）
    ↓
mockあり？ ─Yes→ mockを返す（実サーバー接続なし）
    ↓ No
実サーバーにproxy & record
    ↓
レスポンスを返す
```

### モード一覧（変更後）

| モード | 動作 | 用途 |
|--------|------|------|
| `proxy` | 常に実サーバーに転送 | 本番同等の動作確認 |
| `record` | 常に実サーバーに転送＆記録 | mockデータ作成 |
| `mock` | 常にmockを返す（fallback設定あり） | オフラインテスト |
| **`smart`** | mockあり→mock、なし→proxy&record | **通常開発（推奨）** |

### 詳細仕様

- パターン必須（未選択時は400エラー）
- マッチング: 既存の`storage.findMatchingFile`を使用
- ログ出力:
  - mockヒット時: `GET /users/1 → smart → mock → users_001.json (200)`
  - record時: `GET /users/2 → smart → record → saved users_002.json (200, 1.2KB)`
- SSEイベント: record時のみ発行（`file_created` / `file_updated`）
- `mockFallback`設定の影響を受けない

---

## 影響範囲

### 1. コード修正

#### server（必須）

| ファイル | 変更内容 |
|----------|----------|
| `shared/types/mode.ts` | ModeSchemaに`"smart"`を追加 |
| `server/handlers/handler.ts` | switch文に`case "smart"`を追加 |
| `server/handlers/smart.ts` | **新規作成** - smartモードハンドラー |
| `server/handlers/control-api.ts` | validModes配列に`"smart"`を追加 (L59) |
| `server/core/state.ts` | 変更不要（Mode型が自動更新される） |

#### client（必須）

| ファイル | 変更内容 |
|----------|----------|
| `client/src/components/TopBar.tsx` | modesに`smart`を追加（icon: `◇` or `⚡`） |
| `client/src/types/index.ts` | 変更不要（shared/typesから自動継承） |
| `client/src/hooks/useSnaperroAPI.ts` | 変更不要（Mode型が自動更新される） |

#### demo（必須）

| ファイル | 変更内容 |
|----------|----------|
| `demo/src/components/ModeSelector.tsx` | modeConfigに`smart`を追加 |
| `demo/src/components/GuidePanel.tsx` | smartモードの説明を追加（任意） |

---

### 2. 設定ファイル修正

| ファイル | 変更内容 |
|----------|----------|
| `snaperro.config.ts` | コメントでsmartモードの説明を追記 |

---

### 3. README修正

| ファイル | 変更内容 |
|----------|----------|
| `README.md` | 4モードの説明表を更新、smartモードのユースケース追加 |
| `README_ja.md` | 同上（日本語） |

修正箇所:
- "3 Modes" → "4 Modes" に変更
- モード一覧表にsmartを追加
- smartモードの説明セクションを追加

---

### 4. テスト修正・追加

#### 既存テスト修正

| ファイル | 変更内容 |
|----------|----------|
| `server/core/state.test.ts` | smartモードのテストケース追加 |
| `server/handlers/handler.test.ts` | smartモードのルーティングテスト追加 |
| `server/handlers/control-api.test.ts` | validModesに`"smart"`追加の確認 |

#### 新規テスト追加

| ファイル | 内容 |
|----------|------|
| `server/handlers/smart.test.ts` | **新規作成** |

smartモードのテストケース:
- パターン未選択時は400エラー
- 既存mockがある場合はmockを返す
- 既存mockがない場合はproxy&recordする
- ログ出力の確認

---

## 実装順序

### Phase 1: 型定義・コア実装

1. `shared/types/mode.ts` - ModeSchemaに`"smart"`追加
2. `server/handlers/smart.ts` - 新規作成
3. `server/handlers/handler.ts` - switch文にsmart追加
4. `server/handlers/control-api.ts` - validModes更新

### Phase 2: テスト

5. `server/handlers/smart.test.ts` - 新規作成
6. 既存テストの修正（state.test.ts, handler.test.ts, control-api.test.ts）

### Phase 3: クライアント

7. `client/src/components/TopBar.tsx` - smartボタン追加
8. `demo/src/components/ModeSelector.tsx` - smartボタン追加

### Phase 4: ドキュメント

9. `README.md` / `README_ja.md` - 更新
10. `snaperro.config.ts` - コメント追記

### Phase 5: 確認

11. `pnpm type-check` - 型チェック
12. `pnpm type-check:client` - クライアント型チェック
13. `pnpm type-check:demo` - デモ型チェック
14. `pnpm format` - フォーマット
15. `pnpm test` - テスト実行

---

## 新規ファイル: smart.ts 設計

```typescript
// server/handlers/smart.ts
import type { Context } from "hono";
import { logger } from "../core/logger.js";
import type { MatchResult } from "../core/matcher.js";
import { parseQueryParams, parseRequestBody } from "../core/request-utils.js";
import { state } from "../core/state.js";
import { storage } from "../core/storage.js";
import { handleRecord } from "./recorder.js";

/**
 * Smart mode handler
 * Return mock if exists, otherwise proxy & record
 */
export async function handleSmart(c: Context, match: MatchResult): Promise<Response> {
  const method = c.req.method;
  const url = new URL(c.req.url);
  const path = url.pathname;
  const pattern = state.getPattern();

  // 1. パターン必須チェック
  if (!pattern) {
    logger.warn(`${method} ${path} → no pattern selected`);
    return c.json({
      error: "No pattern selected",
      message: "Please select a pattern first",
    }, 400);
  }

  // 2. クエリパラメータ・ボディ取得
  const queryParams = parseQueryParams(url);
  const requestBody = await parseRequestBody(method, () => c.req.text());

  // 3. 既存mockを検索
  const result = await storage.findMatchingFile(
    pattern,
    method,
    match.matchedRoute,
    match.pathParams,
    queryParams,
    requestBody,
  );

  // 4. mockがあれば返す
  if (result) {
    logger.info(`${method} ${path} → smart → mock → ${result.filePath} (${result.fileData.response.status})`);

    const status = result.fileData.response.status;
    if (status === 304 || status === 204) {
      return c.body(null, status as never);
    }
    return c.json(result.fileData.response.body as object, status as never);
  }

  // 5. mockがなければrecord
  logger.info(`${method} ${path} → smart → record`);
  return handleRecord(c, match);
}
```

---

## UI設計

### TopBar（client）

```typescript
const modes: { value: Mode; label: string; icon: string }[] = [
  { value: "proxy", label: "Proxy", icon: "→" },
  { value: "record", label: "Record", icon: "●" },
  { value: "mock", label: "Mock", icon: "◆" },
  { value: "smart", label: "Smart", icon: "⚡" },  // 追加
];
```

### ModeSelector（demo）

```typescript
const modeConfig: Record<Mode, { label: string; icon: string; description: string }> = {
  proxy: { ... },
  record: { ... },
  mock: { ... },
  smart: {  // 追加
    label: "Smart",
    icon: "⚡",
    description: "Return mock if exists, otherwise record",
  },
};
```

---

## チェックリスト

- [ ] `shared/types/mode.ts` - "smart"追加
- [ ] `server/handlers/smart.ts` - 新規作成
- [ ] `server/handlers/handler.ts` - switch文更新
- [ ] `server/handlers/control-api.ts` - validModes更新
- [ ] `server/handlers/smart.test.ts` - 新規作成
- [ ] `server/core/state.test.ts` - テスト追加
- [ ] `server/handlers/handler.test.ts` - テスト追加
- [ ] `server/handlers/control-api.test.ts` - テスト更新
- [ ] `client/src/components/TopBar.tsx` - smart追加
- [ ] `demo/src/components/ModeSelector.tsx` - smart追加
- [ ] `README.md` - 4モードに更新
- [ ] `README_ja.md` - 4モードに更新
- [ ] `snaperro.config.ts` - コメント追記
- [ ] `pnpm type-check` - 成功
- [ ] `pnpm type-check:client` - 成功
- [ ] `pnpm type-check:demo` - 成功
- [ ] `pnpm format` - 成功
- [ ] `pnpm test` - 成功
