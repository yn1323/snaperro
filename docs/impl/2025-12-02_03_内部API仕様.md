# snaperro 内部API仕様

## 概要

snaperroサーバーは、GUIや外部からサーバーを制御するための内部APIを提供します。
全てのエンドポイントは `/__snaperro__/` プレフィックスを使用します。

---

## エンドポイント一覧

### サーバー状態

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/status` | サーバー状態の一括取得 |

### モード操作

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/mode` | 現在のモード取得 |
| PUT | `/__snaperro__/mode` | モード変更 |

### シナリオ操作

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/scenarios` | シナリオ一覧取得 |
| GET | `/__snaperro__/scenarios/current` | 現在選択中のシナリオ取得 |
| PUT | `/__snaperro__/scenarios/current` | シナリオ切替 |
| POST | `/__snaperro__/scenarios` | 新規シナリオ作成 |
| POST | `/__snaperro__/scenarios/:name/duplicate` | シナリオ複製 |
| PUT | `/__snaperro__/scenarios/:name/rename` | シナリオ名変更 |
| DELETE | `/__snaperro__/scenarios/:name` | シナリオ削除 |
| GET | `/__snaperro__/scenarios/:name/download` | シナリオzipダウンロード |
| POST | `/__snaperro__/scenarios/upload` | シナリオzipアップロード |

### 記録データ操作（RESTful）

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/__snaperro__/scenarios/:scenario/files` | 記録ファイル一覧取得 |
| GET | `/__snaperro__/scenarios/:scenario/files/:filename` | 記録ファイル内容取得 |
| GET | `/__snaperro__/scenarios/:scenario/files/:filename/download` | 記録ファイル個別ダウンロード |
| POST | `/__snaperro__/scenarios/:scenario/files/upload` | 記録ファイルアップロード |
| PUT | `/__snaperro__/scenarios/:scenario/files/:filename` | 記録ファイル編集 |
| DELETE | `/__snaperro__/scenarios/:scenario/files/:filename` | 記録ファイル削除 |

---

## エンドポイント詳細

### GET /__snaperro__/status

サーバーの現在の状態を一括で取得します。

**レスポンス**

```json
{
  "mode": "mock",
  "currentScenario": "正常系フル",
  "scenarios": ["正常系フル", "空データ", "エラー系"],
  "filesCount": 15
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| mode | string | 現在のモード（proxy/record/mock） |
| currentScenario | string \| null | 選択中のシナリオ名 |
| scenarios | string[] | シナリオ一覧 |
| filesCount | number | 現在のシナリオ内の記録ファイル数 |

---

### GET /__snaperro__/mode

現在のモードを取得します。

**レスポンス**

```json
{
  "mode": "mock"
}
```

---

### PUT /__snaperro__/mode

モードを変更します。

**リクエスト**

```json
{
  "mode": "record"
}
```

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| mode | string | Yes | 変更先のモード（proxy/record/mock） |

**レスポンス**

```json
{
  "mode": "record",
  "message": "Mode changed to record"
}
```

**エラーレスポンス**

```json
{
  "error": "Invalid mode",
  "validModes": ["proxy", "record", "mock"]
}
```

---

### GET /__snaperro__/scenarios

シナリオ一覧を取得します。

**レスポンス**

```json
{
  "scenarios": [
    {
      "name": "正常系フル",
      "filesCount": 10,
      "createdAt": "2025-12-02T10:00:00.000Z",
      "updatedAt": "2025-12-02T12:00:00.000Z"
    },
    {
      "name": "空データ",
      "filesCount": 3,
      "createdAt": "2025-12-02T10:30:00.000Z",
      "updatedAt": "2025-12-02T10:30:00.000Z"
    }
  ]
}
```

---

### GET /__snaperro__/scenarios/current

現在選択中のシナリオを取得します。

**レスポンス**

```json
{
  "currentScenario": "正常系フル"
}
```

シナリオが選択されていない場合：

```json
{
  "currentScenario": null
}
```

---

### PUT /__snaperro__/scenarios/current

シナリオを切り替えます。

**リクエスト**

```json
{
  "scenario": "エラー系"
}
```

**レスポンス**

```json
{
  "currentScenario": "エラー系",
  "message": "Scenario changed to エラー系"
}
```

**エラーレスポンス**

```json
{
  "error": "Scenario not found",
  "scenario": "存在しないシナリオ"
}
```

---

### POST /__snaperro__/scenarios

新規シナリオを作成します。

**リクエスト**

```json
{
  "name": "決済エラー"
}
```

**レスポンス**

```json
{
  "name": "決済エラー",
  "message": "Scenario created"
}
```

**エラーレスポンス**

```json
{
  "error": "Scenario already exists",
  "name": "決済エラー"
}
```

---

### POST /__snaperro__/scenarios/:name/duplicate

既存シナリオを複製します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | 複製元のシナリオ名 |

**リクエスト**

```json
{
  "newName": "正常系フル_コピー"
}
```

**レスポンス**

```json
{
  "source": "正常系フル",
  "destination": "正常系フル_コピー",
  "message": "Scenario duplicated"
}
```

---

### PUT /__snaperro__/scenarios/:name/rename

シナリオ名を変更します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | 現在のシナリオ名 |

**リクエスト**

```json
{
  "newName": "正常系_完全版"
}
```

**レスポンス**

```json
{
  "oldName": "正常系フル",
  "newName": "正常系_完全版",
  "message": "Scenario renamed"
}
```

---

### DELETE /__snaperro__/scenarios/:name

シナリオを削除します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | 削除するシナリオ名 |

**レスポンス**

```json
{
  "name": "エラー系",
  "message": "Scenario deleted"
}
```

**エラーレスポンス（選択中のシナリオを削除しようとした場合）**

```json
{
  "error": "Cannot delete current scenario",
  "name": "正常系フル"
}
```

---

### GET /__snaperro__/scenarios/:name/download

シナリオをzipファイルとしてダウンロードします。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| name | ダウンロードするシナリオ名 |

**レスポンス**

- Content-Type: `application/zip`
- Content-Disposition: `attachment; filename="正常系フル.zip"`
- Body: zipファイルのバイナリデータ

---

### POST /__snaperro__/scenarios/upload

zipファイルからシナリオをアップロードします。

**リクエスト**

- Content-Type: `multipart/form-data`
- Body:
  - `file`: zipファイル
  - `name`: シナリオ名（省略時はzipファイル名を使用）

**レスポンス**

```json
{
  "name": "アップロードシナリオ",
  "filesCount": 5,
  "message": "Scenario uploaded"
}
```

---

### GET /__snaperro__/scenarios/:scenario/files

指定シナリオ内の記録ファイル一覧を取得します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| scenario | シナリオ名 |

**レスポンス**

```json
{
  "scenario": "正常系フル",
  "files": [
    {
      "filename": "api_users_001.json",
      "endpoint": "/api/users",
      "method": "GET",
      "size": 1024,
      "updatedAt": "2025-12-02T12:00:00.000Z"
    },
    {
      "filename": "api_users_002.json",
      "endpoint": "/api/users",
      "method": "POST",
      "size": 2048,
      "updatedAt": "2025-12-02T12:30:00.000Z"
    }
  ]
}
```

---

### GET /__snaperro__/scenarios/:scenario/files/:filename

記録ファイルの内容を取得します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| scenario | シナリオ名 |
| filename | ファイル名（例: `api_users_001.json`） |

**レスポンス**

```json
{
  "endpoint": "/api/users",
  "method": "GET",
  "request": {
    "pathParams": {},
    "queryParams": { "status": "active" },
    "headers": { "Authorization": "Bearer xxx" },
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": {
      "users": [
        { "id": 1, "name": "田中" }
      ]
    }
  }
}
```

---

### GET /__snaperro__/scenarios/:scenario/files/:filename/download

記録ファイルを個別にダウンロードします。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| scenario | シナリオ名 |
| filename | ファイル名 |

**レスポンス**

- Content-Type: `application/json`
- Content-Disposition: `attachment; filename="api_users_001.json"`
- Body: JSONファイルの内容

---

### POST /__snaperro__/scenarios/:scenario/files/upload

記録ファイルをアップロードします。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| scenario | シナリオ名 |

**リクエスト**

- Content-Type: `multipart/form-data`
- Body:
  - `file`: JSONファイル

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "File uploaded"
}
```

---

### PUT /__snaperro__/scenarios/:scenario/files/:filename

記録ファイルの内容を編集します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| scenario | シナリオ名 |
| filename | ファイル名 |

**リクエスト**

```json
{
  "endpoint": "/api/users",
  "method": "GET",
  "request": {
    "pathParams": {},
    "queryParams": { "status": "active" },
    "headers": {},
    "body": null
  },
  "response": {
    "status": 200,
    "headers": { "Content-Type": "application/json" },
    "body": {
      "users": []
    }
  }
}
```

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "File updated"
}
```

---

### DELETE /__snaperro__/scenarios/:scenario/files/:filename

記録ファイルを削除します。

**パスパラメータ**

| パラメータ | 説明 |
|-----------|------|
| scenario | シナリオ名 |
| filename | ファイル名 |

**レスポンス**

```json
{
  "filename": "api_users_001.json",
  "message": "File deleted"
}
```

---

## 共通エラーレスポンス

### 400 Bad Request

リクエストが不正な場合

```json
{
  "error": "Invalid request",
  "details": "Missing required field: name"
}
```

### 404 Not Found

リソースが見つからない場合

```json
{
  "error": "Not found",
  "resource": "scenario",
  "name": "存在しないシナリオ"
}
```

### 500 Internal Server Error

サーバー内部エラー

```json
{
  "error": "Internal server error",
  "message": "Failed to write file"
}
```

---

## 関連ドキュメント

- [概要](./2025-12-02_01_概要.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
- [JSONスキーマ仕様](./2025-12-02_06_JSONスキーマ仕様.md)
