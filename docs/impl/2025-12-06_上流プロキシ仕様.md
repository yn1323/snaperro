# 上流プロキシ仕様

## 概要

企業ネットワーク環境では、外部APIへのアクセスにプロキシサーバーを経由する必要があることがあります。snaperroは上流プロキシ（upstream proxy）をサポートし、企業プロキシ環境下でも動作可能です。

---

## 設定方法

上流プロキシは以下の2つの方法で設定できます。

### 1. 設定ファイルで指定

`snaperro.config.ts` に `upstreamProxy` を追加します。

```typescript
import { defineConfig } from 'snaperro'

export default defineConfig({
  port: 3333,

  // 上流プロキシ設定
  upstreamProxy: {
    url: "http://proxy.company.com:8080",
  },

  apis: {
    // ...
  },
})
```

### 2. 環境変数で指定

以下の環境変数を設定します。

```bash
# HTTPS通信用（推奨）
export HTTPS_PROXY=http://proxy.company.com:8080

# HTTP通信用
export HTTP_PROXY=http://proxy.company.com:8080
```

Windows (PowerShell):

```powershell
$env:HTTPS_PROXY = "http://proxy.company.com:8080"
```

Windows (コマンドプロンプト):

```cmd
set HTTPS_PROXY=http://proxy.company.com:8080
```

---

## 優先順位

設定が複数ある場合、以下の優先順位で適用されます。

| 優先度 | 設定方法 |
|--------|----------|
| 1（高） | 設定ファイル（`upstreamProxy.url`） |
| 2 | 環境変数 `HTTPS_PROXY` |
| 3 | 環境変数 `HTTP_PROXY` |
| 4 | 環境変数 `https_proxy`（小文字） |
| 5（低） | 環境変数 `http_proxy`（小文字） |

設定ファイルに `upstreamProxy` が指定されている場合、環境変数は無視されます。

---

## 認証付きプロキシ

認証が必要なプロキシは、URL形式でユーザー名とパスワードを指定します。

```
http://username:password@proxy.company.com:8080
```

### 設定ファイルでの指定

```typescript
export default defineConfig({
  upstreamProxy: {
    url: "http://username:password@proxy.company.com:8080",
  },
  // ...
})
```

### 環境変数での指定

```bash
export HTTPS_PROXY=http://username:password@proxy.company.com:8080
```

**セキュリティに関する注意:**
- 設定ファイルにパスワードを直接書く場合は、`.gitignore` に追加するか環境変数を使用してください
- ログ出力時、認証情報は `***` でマスクされます

---

## 動作モードとの関係

上流プロキシは以下のモードで使用されます。

| モード | 上流プロキシ使用 | 説明 |
|--------|-----------------|------|
| Proxy | Yes | 実際のAPIにプロキシ経由でアクセス |
| Record | Yes | 実際のAPIにプロキシ経由でアクセスし記録 |
| Mock | No | ローカルJSONを返すため不要 |

---

## 使用例

### 例1: シンプルなプロキシ設定

```typescript
// snaperro.config.ts
export default defineConfig({
  upstreamProxy: {
    url: "http://proxy.company.com:8080",
  },
  apis: {
    userService: {
      name: "User API",
      target: "https://api.example.com",
      routes: ["/api/users", "/api/users/:id"],
    },
  },
})
```

### 例2: 環境変数のみで設定

```bash
# .env
HTTPS_PROXY=http://proxy.company.com:8080
API_KEY=your-api-key
```

```typescript
// snaperro.config.ts
// upstreamProxy は省略（環境変数から自動検出）
export default defineConfig({
  apis: {
    userService: {
      name: "User API",
      target: "https://api.example.com",
      headers: {
        "X-Api-Key": process.env.API_KEY!,
      },
      routes: ["/api/users"],
    },
  },
})
```

### 例3: 認証付きプロキシ（環境変数推奨）

```bash
# .env（Git管理しない）
HTTPS_PROXY=http://tanaka:secretpass@proxy.company.com:8080
```

```typescript
// snaperro.config.ts（Git管理する）
// upstreamProxy は省略
export default defineConfig({
  apis: { /* ... */ },
})
```

---

## トラブルシューティング

### プロキシ経由で接続できない

1. プロキシURLが正しいか確認
   ```bash
   curl -x http://proxy.company.com:8080 https://api.example.com
   ```

2. 認証が必要なプロキシの場合、ユーザー名/パスワードを確認

3. `--verbose` オプションで詳細ログを確認
   ```bash
   npx snaperro start --verbose
   ```

### 407 Proxy Authentication Required

プロキシ認証が必要です。URL形式で認証情報を追加してください。

```
http://username:password@proxy.company.com:8080
```

---

## 設定スキーマ

```typescript
interface UpstreamProxyConfig {
  /**
   * プロキシサーバーのURL
   * 認証が必要な場合は http://user:pass@host:port 形式
   */
  url: string
}

interface SnaperroConfig {
  port?: number
  filesDir?: string
  upstreamProxy?: UpstreamProxyConfig  // 追加
  apis: Record<string, ApiConfig>
}
```

---

## 技術詳細

- Node.js 18+ に内蔵されている `undici` の `ProxyAgent` を使用
- 追加の npm パッケージは不要
- Windows / Mac / Linux 対応

---

## 関連ドキュメント

- [設定ファイル仕様](./2025-12-02_04_設定ファイル仕様.md)
- [サーバー仕様](./2025-12-02_02_サーバー仕様.md)
- [CLIコマンド仕様](./2025-12-02_05_CLIコマンド仕様.md)
