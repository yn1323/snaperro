# リクエストログパネル実装計画

## 概要
クライアントUIの下部に折りたたみ可能なログパネルを追加し、HTTPリクエストログをリアルタイム表示する。

## 要件
- **UI**: 下部にログパネル
  - **非表示時**: 1行フッター（直近1件のログ + 展開ボタン）
  - **表示時**: リサイズ可能なログパネル（高さをLocalStorageで保存）
- **内容**: HTTPリクエストログのみ（例: `GET /api/users → mock → 200`）
- **パフォーマンス**: EditorPane（重いJSONファイル表示）の再レンダリングを引き起こさないこと

---

## UI設計

### 非表示時（1行フッター）
```
┌─────────────────────────────────────────────────────────────┐
│ 14:32:01 GET /api/users → mock → 200              [展開]    │
└─────────────────────────────────────────────────────────────┘
```
- 高さ: 32px固定
- 直近1件のログを表示（ログがない場合は "No requests yet"）
- 右側に展開ボタン（LuChevronUp等のアイコン使用）

### 表示時（ログパネル）
```
┌══════════════════════════════════════════════════════════════┐  ← リサイズハンドル（ドラッグで高さ変更）
│ Request Log (12)                                [Clear] [縮小] │
├─────────────────────────────────────────────────────────────┤
│ 14:32:01 GET /api/users → mock → 200                        │
│ 14:32:02 POST /api/users → record → 201                     │
│ ...                                                          │
└─────────────────────────────────────────────────────────────┘
```
- デフォルト高さ: 200px
- 最小高さ: 100px、最大高さ: 50vh
- 高さはLocalStorageに保存
- 縮小ボタンにはLuChevronDown等のアイコン使用

---

## 実装ステップ

### Step 1: SSEイベント型を追加
**ファイル**: `shared/types/sse.ts`

```typescript
// SSEEventType に追加
| "request_log"

// 新しいインターフェース
export interface RequestLogEventData {
  id: string;
  timestamp: string;
  method: string;
  path: string;
  action: "proxy" | "record" | "mock" | "smart";
  subAction?: "mock" | "record";
  status: number;
  filePath?: string;
  duration?: number;
}
```

### Step 2: logger.request() メソッドを追加
**ファイル**: `server/core/logger.ts`

1. コンソールに出力（既存の動作）
2. `eventBus.emitSSE("request_log", data)` でSSEイベントを発行

### Step 3: 各ハンドラーで logger.request() を使用
**ファイル**:
- `server/handlers/proxy.ts`
- `server/handlers/recorder.ts`
- `server/handlers/mocker.ts`
- `server/handlers/smart.ts`

### Step 4: useSnaperroSSE フックを更新
**ファイル**: `client/src/hooks/useSnaperroSSE.ts`

`request_log` イベントを処理する `onRequestLog` コールバックを追加。

### Step 5: LogPanel コンポーネントを作成（独立コンポーネント）
**新規ファイル**: `client/src/components/LogPanel.tsx`

LogPanelは内部で全ての状態を管理する独立したコンポーネント:
- ログデータの状態管理（useState）
- パネル開閉状態（useState + localStorage）
- パネル高さ（useState + localStorage）
- SSEイベントの購読（useSnaperroSSEから渡されるコールバック経由）

```tsx
interface LogPanelProps {
  onRequestLog: (callback: (log: RequestLogEventData) => void) => void;
}

export const LogPanel = memo(function LogPanel({ onRequestLog }: LogPanelProps) {
  const [logs, setLogs] = useState<RequestLogEventData[]>([]);
  const [isOpen, setIsOpen] = useState(() =>
    localStorage.getItem("snaperro-log-panel-open") === "true"
  );
  const [height, setHeight] = useState(() =>
    Number(localStorage.getItem("snaperro-log-panel-height")) || 200
  );

  // SSEイベントを購読
  useEffect(() => {
    onRequestLog((log) => {
      setLogs((prev) => [...prev.slice(-99), log]);
    });
  }, [onRequestLog]);

  // 非表示時: 1行フッター
  // 表示時: リサイズ可能なログパネル
});
```

### Step 6: Layoutを更新
**ファイル**: `client/src/components/Layout.tsx`

LogPanelをpropsとして受け取り、3ペインの下に配置:
```tsx
interface LayoutProps {
  // ...existing props...
  logPanel: ReactNode;
}

<Flex direction="column" h="100vh">
  {topBar}
  <Flex flex={1} overflow="hidden">
    {/* 3ペイン */}
  </Flex>
  {logPanel}
</Flex>
```

### Step 7: App.tsxで統合
**ファイル**: `client/src/App.tsx`

```tsx
// SSEフックにコールバック登録用の関数を追加
const { registerRequestLogHandler } = useSnaperroSSE({ ... });

<Layout
  // ...existing props...
  logPanel={<LogPanel onRequestLog={registerRequestLogHandler} />}
/>
```

---

## パフォーマンス戦略

1. **LogPanel内部で状態管理**: App.tsxの状態に影響しない
2. **React.memo**: LogPanelと個々のログエントリをメモ化
3. **コールバック経由のSSE購読**: 親コンポーネントの再レンダリングを回避

これにより:
- ログ追加時 → LogPanelのみ再レンダリング
- EditorPane（重いJSON）→ **影響なし**
- TopBar → **影響なし**

---

## 作成するファイル
- `client/src/components/LogPanel.tsx`

## 変更するファイル
- `shared/types/sse.ts`
- `server/core/logger.ts`
- `server/handlers/proxy.ts`
- `server/handlers/recorder.ts`
- `server/handlers/mocker.ts`
- `server/handlers/smart.ts`
- `client/src/hooks/useSnaperroSSE.ts`
- `client/src/components/Layout.tsx`
- `client/src/App.tsx`
